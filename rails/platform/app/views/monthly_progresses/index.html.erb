<div class="max-w-6xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900"><%= @year %>年<%= @month %>月 出来高入力</h1>
      <p class="text-sm text-gray-500">各案件の累計出来高を入力してください（金額入力 → 進捗率は自動計算）</p>
    </div>
    <div class="flex space-x-2">
      <%= button_to "前月からコピー", copy_from_previous_monthly_progresses_path(year: @year, month: @month),
          method: :post,
          class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 cursor-pointer" %>
      <%= link_to "月次損益計算書", monthly_income_statement_path(year: @year, month: @month),
          class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    </div>
  </div>

  <%# 月移動ナビゲーション %>
  <div class="flex items-center justify-between mb-6 bg-gray-50 rounded-lg p-3">
    <% prev_date = Date.new(@year, @month, 1).prev_month %>
    <% next_date = Date.new(@year, @month, 1).next_month %>
    <%= link_to monthly_progresses_path(year: prev_date.year, month: prev_date.month),
        class: "inline-flex items-center text-sm text-gray-600 hover:text-gray-900" do %>
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      <%= prev_date.month %>月
    <% end %>
    <span class="font-medium text-gray-900"><%= @year %>年<%= @month %>月</span>
    <%= link_to monthly_progresses_path(year: next_date.year, month: next_date.month),
        class: "inline-flex items-center text-sm text-gray-600 hover:text-gray-900" do %>
      <%= next_date.month %>月
      <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    <% end %>
  </div>

  <% if @projects.any? %>
    <%= form_with url: bulk_update_monthly_progresses_path(year: @year, month: @month), method: :patch, local: true do |f| %>
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">案件名</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">受注額</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">前月出来高</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-36">
                当月累計出来高
                <span class="block text-[10px] text-gray-400 normal-case">（金額入力）</span>
              </th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-20">進捗率</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">請求済（税抜）</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-28">未請求</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @projects.each do |project| %>
              <% progress = @progresses[project.id] %>
              <% prev_progress = @prev_progresses[project.id] %>
              <% prev_amount = prev_progress&.progress_amount || 0 %>
              <% current_amount = progress&.progress_amount || prev_amount %>
              <% invoiced = @total_invoiced[project.id] || 0 %>
              <% unbilled = [current_amount - invoiced, 0].max %>
              <tr class="hover:bg-gray-50" data-controller="progress-calc" data-progress-calc-order-value="<%= project.order_amount || 0 %>">
                <td class="px-4 py-3">
                  <div class="text-sm font-medium text-gray-900"><%= project.name %></div>
                  <div class="text-xs text-gray-500"><%= project.client&.name %></div>
                </td>
                <td class="px-4 py-3 text-right text-sm text-gray-900">
                  <%= number_to_currency(project.order_amount || 0, unit: "", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-right text-sm text-gray-500">
                  <%= number_to_currency(prev_amount, unit: "", precision: 0) %>
                </td>
                <td class="px-4 py-3">
                  <div class="relative">
                    <input type="text"
                           name="progresses[<%= project.id %>][progress_amount]"
                           value="<%= current_amount.to_i %>"
                           class="block w-full text-right rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                           inputmode="numeric"
                           data-progress-calc-target="input"
                           data-action="input->progress-calc#calculate">
                  </div>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                        data-progress-calc-target="rate">
                    <% rate = project.order_amount&.positive? ? ((current_amount.to_d / project.order_amount) * 100).round(1) : 0 %>
                    <%= rate %>%
                  </span>
                </td>
                <td class="px-4 py-3 text-right text-sm text-gray-900">
                  <%= number_to_currency(invoiced, unit: "", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-right">
                  <span class="text-sm font-medium <%= unbilled > 0 ? 'text-orange-600' : 'text-gray-500' %>"
                        data-progress-calc-target="unbilled"
                        data-invoiced="<%= invoiced %>">
                    <%= number_to_currency(unbilled, unit: "", precision: 0) %>
                  </span>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <div class="mt-6 flex justify-end">
        <button type="submit" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 cursor-pointer">
          保存
        </button>
      </div>
    <% end %>

    <%# 集計 %>
    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
      <h4 class="text-sm font-medium text-blue-800 mb-2">当月集計</h4>
      <div class="grid grid-cols-3 gap-4 text-sm">
        <div>
          <span class="text-blue-600">出来高合計:</span>
          <span class="font-medium text-blue-900">
            <% total_progress = @progresses.values.sum { |p| p.progress_amount || 0 } %>
            <%= number_to_currency(total_progress, unit: "¥", precision: 0) %>
          </span>
        </div>
        <div>
          <span class="text-blue-600">請求済合計:</span>
          <span class="font-medium text-blue-900">
            <% total_invoiced = @total_invoiced.values.sum %>
            <%= number_to_currency(total_invoiced, unit: "¥", precision: 0) %>
          </span>
        </div>
        <div>
          <span class="text-blue-600">未請求合計:</span>
          <span class="font-medium text-orange-600">
            <%= number_to_currency([total_progress - total_invoiced, 0].max, unit: "¥", precision: 0) %>
          </span>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-white shadow rounded-lg p-6 text-center">
      <p class="text-gray-500">進行中の案件がありません</p>
    </div>
  <% end %>

  <%# 説明 %>
  <div class="mt-6 bg-gray-50 border border-gray-200 rounded-lg p-4">
    <h4 class="text-sm font-medium text-gray-700 mb-2">出来高入力について</h4>
    <ul class="text-sm text-gray-600 space-y-1">
      <li><strong>累計出来高</strong>: 月末時点の工事進捗金額（税抜）を入力</li>
      <li><strong>進捗率</strong>: 受注額に対する出来高の割合（自動計算）</li>
      <li><strong>未請求</strong>: 出来高 - 請求済み金額（マイナスにはならない）</li>
      <li>月次損益計算書では「出来高」を売上として計算します</li>
    </ul>
  </div>
</div>
