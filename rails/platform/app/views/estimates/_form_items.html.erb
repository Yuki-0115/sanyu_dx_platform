<div class="bg-white shadow rounded-lg p-6"
     data-controller="estimate-items"
     data-estimate-items-item-index-value="<%= @estimate.estimate_items.size %>"
     data-estimate-items-category-index-value="<%= @estimate.estimate_categories.size %>"
     data-estimate-items-overhead-rate-value="<%= @estimate.overhead_rate || 4.0 %>"
     data-estimate-items-welfare-rate-value="<%= @estimate.welfare_rate || 3.0 %>">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-medium text-gray-900">内訳明細</h3>
    <button type="button" class="btn-primary text-sm" data-action="click->estimate-items#addCategory">
      + 工種追加
    </button>
  </div>

  <div data-estimate-items-target="categoriesContainer">
    <% if @estimate.estimate_categories.any? %>
      <%= f.fields_for :estimate_categories do |cat_f| %>
        <%= render "estimates/category_form_section", f: f, cat_f: cat_f, category_index: cat_f.index %>
      <% end %>
    <% elsif @estimate.estimate_items.any? %>
      <!-- 旧データ: 工種なしの項目がある場合 -->
      <div class="category-section mb-6 border border-gray-200 rounded-lg" data-category-index="0">
        <div class="bg-blue-50 px-4 py-3 rounded-t-lg">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <span class="text-blue-700 font-medium category-number">1</span>.
              <input type="hidden" name="estimate[estimate_categories_attributes][0][id]" value="">
              <input type="hidden" name="estimate[estimate_categories_attributes][0][sort_order]" value="0">
              <input type="text" name="estimate[estimate_categories_attributes][0][name]"
                     class="category-name-input font-medium text-blue-900 bg-transparent border-b border-blue-300 focus:border-blue-500 focus:outline-none px-1 w-48"
                     placeholder="工種名を入力" value="工事">
              <span class="text-blue-700">一式</span>
            </div>
            <div class="flex items-center gap-4">
              <span class="text-blue-700 font-medium category-subtotal"><%= number_to_currency(@estimate.subtotal, unit: "¥", precision: 0) %></span>
              <button type="button" class="text-green-600 hover:text-green-800 text-sm font-medium"
                      data-action="click->estimate-items#goToBudget">
                予算作成 →
              </button>
            </div>
          </div>
          <div class="mt-2 flex gap-6 text-sm">
            <div class="flex items-center gap-1">
              <span class="text-gray-600">諸経費</span>
              <input type="number" name="estimate[estimate_categories_attributes][0][overhead_rate]"
                     step="0.1" min="0" max="100" value="<%= @estimate.overhead_rate || 4.0 %>"
                     class="w-16 rounded border-gray-300 text-sm text-right category-overhead-rate"
                     data-action="input->estimate-items#calculateRates">
              <span class="text-gray-500">%</span>
              <span class="text-gray-600 ml-2 category-overhead-cost"><%= number_to_currency(@estimate.overhead_cost, unit: "¥", precision: 0) %></span>
            </div>
            <div class="flex items-center gap-1">
              <span class="text-gray-600">法定福利費</span>
              <input type="number" name="estimate[estimate_categories_attributes][0][welfare_rate]"
                     step="0.1" min="0" max="100" value="<%= @estimate.welfare_rate || 3.0 %>"
                     class="w-16 rounded border-gray-300 text-sm text-right category-welfare-rate"
                     data-action="input->estimate-items#calculateRates">
              <span class="text-gray-500">%</span>
              <span class="text-gray-600 ml-2 category-welfare-cost"><%= number_to_currency(@estimate.welfare_cost, unit: "¥", precision: 0) %></span>
            </div>
            <div class="flex items-center gap-1 ml-auto">
              <span class="text-gray-600">直接工事費</span>
              <span class="font-medium category-direct-cost"><%= number_to_currency(@estimate.direct_cost, unit: "¥", precision: 0) %></span>
            </div>
          </div>
        </div>
        <div class="p-4">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">名称</th>
                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-32">規格</th>
                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-24">数量</th>
                <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-20">単位</th>
                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-28">単価</th>
                <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-32">金額</th>
                <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-32">備考</th>
                <th class="px-2 py-2 w-10"></th>
              </tr>
            </thead>
            <tbody class="category-items-body bg-white divide-y divide-gray-200">
              <% @estimate.estimate_items.each_with_index do |item, idx| %>
                <tr class="item-row">
                  <td class="px-1 py-1">
                    <%= hidden_field_tag "estimate[estimate_items_attributes][#{idx}][id]", item.id if item.persisted? %>
                    <%= hidden_field_tag "estimate[estimate_items_attributes][#{idx}][_destroy]", "0", class: "destroy-field" %>
                    <input type="text" name="estimate[estimate_items_attributes][<%= idx %>][name]"
                           value="<%= item.name %>"
                           class="block w-full rounded border-gray-300 text-sm" placeholder="項目名">
                  </td>
                  <td class="px-1 py-1">
                    <input type="text" name="estimate[estimate_items_attributes][<%= idx %>][specification]"
                           value="<%= item.specification %>"
                           class="block w-full rounded border-gray-300 text-sm" placeholder="規格">
                  </td>
                  <td class="px-1 py-1">
                    <input type="number" name="estimate[estimate_items_attributes][<%= idx %>][quantity]"
                           value="<%= item.quantity %>"
                           step="0.01" class="block w-full rounded border-gray-300 text-sm text-right estimate-qty"
                           data-action="input->estimate-items#calculateRow">
                  </td>
                  <td class="px-1 py-1">
                    <select name="estimate[estimate_items_attributes][<%= idx %>][unit]"
                            class="block w-full rounded border-gray-300 text-sm">
                      <option value="">-</option>
                      <% Estimate::UNIT_OPTIONS.each do |unit| %>
                        <option value="<%= unit %>" <%= 'selected' if item.unit == unit %>><%= unit %></option>
                      <% end %>
                    </select>
                  </td>
                  <td class="px-1 py-1">
                    <input type="number" name="estimate[estimate_items_attributes][<%= idx %>][unit_price]"
                           value="<%= item.unit_price %>"
                           step="1" class="block w-full rounded border-gray-300 text-sm text-right estimate-price"
                           data-action="input->estimate-items#calculateRow">
                  </td>
                  <td class="px-1 py-1 text-right font-medium estimate-amount">
                    <% if item.amount.to_i > 0 %>
                      <%= number_to_currency(item.amount, unit: "¥", precision: 0) %>
                    <% else %>
                      -
                    <% end %>
                  </td>
                  <td class="px-1 py-1">
                    <input type="text" name="estimate[estimate_items_attributes][<%= idx %>][note]"
                           value="<%= item.note %>"
                           class="block w-full rounded border-gray-300 text-sm">
                  </td>
                  <td class="px-1 py-1">
                    <input type="hidden" name="estimate[estimate_items_attributes][<%= idx %>][sort_order]" value="<%= item.sort_order || idx %>">
                    <button type="button" class="text-red-500 hover:text-red-700" data-action="click->estimate-items#removeItem">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
          <button type="button" class="mt-2 text-sm text-blue-600 hover:text-blue-800" data-action="click->estimate-items#addItem">
            + 項目追加
          </button>
        </div>
      </div>
    <% else %>
      <p class="text-gray-500 text-center py-8" data-estimate-items-target="noMessage">
        「+ 工種追加」ボタンから工種を追加してください
      </p>
    <% end %>
  </div>

  <!-- 全体サマリー -->
  <div class="mt-6 bg-gray-50 rounded-lg p-4">
    <table class="w-full text-sm">
      <tbody>
        <tr class="border-b">
          <td class="py-2 w-1/3">直接工事費（税抜）</td>
          <td class="py-2 text-right w-1/3 font-medium" data-estimate-items-target="directCostDisplay">
            <%= number_to_currency(@estimate.direct_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2 w-1/3"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">諸経費 合計</td>
          <td class="py-2 text-right font-medium" data-estimate-items-target="overheadCostDisplay">
            <%= number_to_currency(@estimate.overhead_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">法定福利費 合計</td>
          <td class="py-2 text-right font-medium" data-estimate-items-target="welfareCostDisplay">
            <%= number_to_currency(@estimate.welfare_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">
            端数調整
            <span class="ml-2">
              <%= f.number_field :adjustment, step: 1,
                  class: "w-24 rounded border-gray-300 text-sm text-right inline-block",
                  data: { estimate_items_target: "adjustmentInput", action: "input->estimate-items#adjustmentChanged" } %>
              <span class="text-gray-500">円</span>
            </span>
          </td>
          <td class="py-2 text-right font-medium" data-estimate-items-target="adjustmentDisplay">
            <%= number_to_currency(@estimate.adjustment || 0, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-t-2 border-gray-400">
          <td class="py-3 font-medium">合計（税抜）</td>
          <td class="py-3 text-right font-bold text-lg" data-estimate-items-target="subtotalDisplay">
            <%= number_to_currency(@estimate.subtotal, unit: "¥", precision: 0) %>
          </td>
          <td class="py-3"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2 text-gray-600">消費税（10%）</td>
          <td class="py-2 text-right font-medium" data-estimate-items-target="taxDisplay">
            <%= number_to_currency(@estimate.tax_amount, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="bg-blue-50">
          <td class="py-3 font-bold text-blue-900">合計（税込）</td>
          <td class="py-3 text-right font-bold text-xl text-blue-900" data-estimate-items-target="totalDisplay">
            <%= number_to_currency(@estimate.total_amount, unit: "¥", precision: 0) %>
          </td>
          <td class="py-3"></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- 工種セクションテンプレート -->
<template data-estimate-items-target="categoryTemplate">
  <div class="category-section mb-6 border border-gray-200 rounded-lg" data-category-index="NEW_CAT_INDEX">
    <div class="bg-blue-50 px-4 py-3 rounded-t-lg">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-2">
          <span class="text-blue-700 font-medium category-number">1</span>.
          <input type="hidden" name="estimate[estimate_categories_attributes][NEW_CAT_INDEX][id]" value="">
          <input type="hidden" name="estimate[estimate_categories_attributes][NEW_CAT_INDEX][sort_order]" value="NEW_CAT_INDEX" class="category-sort-order">
          <input type="text" name="estimate[estimate_categories_attributes][NEW_CAT_INDEX][name]"
                 class="category-name-input font-medium text-blue-900 bg-transparent border-b border-blue-300 focus:border-blue-500 focus:outline-none px-1 w-48"
                 placeholder="工種名を入力" value=""
                 data-action="input->estimate-items#updateCategoryName">
          <span class="text-blue-700">一式</span>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-blue-700 font-medium category-subtotal">¥0</span>
          <button type="button" class="text-green-600 hover:text-green-800 text-sm font-medium"
                  data-action="click->estimate-items#goToBudget">
            予算作成 →
          </button>
          <button type="button" class="text-red-500 hover:text-red-700" data-action="click->estimate-items#removeCategory">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
      <!-- 諸経費・法定福利費 -->
      <div class="mt-2 flex gap-6 text-sm">
        <div class="flex items-center gap-1">
          <span class="text-gray-600">諸経費</span>
          <input type="number" name="estimate[estimate_categories_attributes][NEW_CAT_INDEX][overhead_rate]"
                 step="0.1" min="0" max="100" value="<%= @estimate.overhead_rate || 4.0 %>"
                 class="w-16 rounded border-gray-300 text-sm text-right category-overhead-rate"
                 data-action="input->estimate-items#calculateRates">
          <span class="text-gray-500">%</span>
          <span class="text-gray-600 ml-2 category-overhead-cost">¥0</span>
        </div>
        <div class="flex items-center gap-1">
          <span class="text-gray-600">法定福利費</span>
          <input type="number" name="estimate[estimate_categories_attributes][NEW_CAT_INDEX][welfare_rate]"
                 step="0.1" min="0" max="100" value="<%= @estimate.welfare_rate || 3.0 %>"
                 class="w-16 rounded border-gray-300 text-sm text-right category-welfare-rate"
                 data-action="input->estimate-items#calculateRates">
          <span class="text-gray-500">%</span>
          <span class="text-gray-600 ml-2 category-welfare-cost">¥0</span>
        </div>
        <div class="flex items-center gap-1 ml-auto">
          <span class="text-gray-600">直接工事費</span>
          <span class="font-medium category-direct-cost">¥0</span>
        </div>
      </div>
    </div>
    <div class="p-4">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">名称</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-32">規格</th>
            <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-24">数量</th>
            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-20">単位</th>
            <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-28">単価</th>
            <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-32">金額</th>
            <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-32">備考</th>
            <th class="px-2 py-2 w-10"></th>
          </tr>
        </thead>
        <tbody class="category-items-body bg-white divide-y divide-gray-200">
        </tbody>
      </table>
      <button type="button" class="mt-2 text-sm text-blue-600 hover:text-blue-800" data-action="click->estimate-items#addItem">
        + 項目追加
      </button>
    </div>
  </div>
</template>

<!-- 項目行テンプレート -->
<template data-estimate-items-target="itemTemplate">
  <tr class="item-row">
    <td class="px-1 py-1">
      <input type="hidden" name="estimate[estimate_items_attributes][NEW_INDEX][estimate_category_id]" value="CAT_ID" class="item-category-id">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][name]"
             class="block w-full rounded border-gray-300 text-sm" placeholder="項目名">
    </td>
    <td class="px-1 py-1">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][specification]"
             class="block w-full rounded border-gray-300 text-sm" placeholder="規格">
    </td>
    <td class="px-1 py-1">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][quantity]"
             step="0.01" class="block w-full rounded border-gray-300 text-sm text-right estimate-qty"
             data-action="input->estimate-items#calculateRow">
    </td>
    <td class="px-1 py-1">
      <select name="estimate[estimate_items_attributes][NEW_INDEX][unit]"
              class="block w-full rounded border-gray-300 text-sm">
        <option value="">-</option>
        <% Estimate::UNIT_OPTIONS.each do |unit| %>
          <option value="<%= unit %>"><%= unit %></option>
        <% end %>
      </select>
    </td>
    <td class="px-1 py-1">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][unit_price]"
             step="1" class="block w-full rounded border-gray-300 text-sm text-right estimate-price"
             data-action="input->estimate-items#calculateRow">
    </td>
    <td class="px-1 py-1 text-right font-medium estimate-amount">-</td>
    <td class="px-1 py-1">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][note]"
             class="block w-full rounded border-gray-300 text-sm">
    </td>
    <td class="px-1 py-1">
      <input type="hidden" name="estimate[estimate_items_attributes][NEW_INDEX][sort_order]" value="0">
      <button type="button" class="text-red-500 hover:text-red-700" data-action="click->estimate-items#removeItem">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </td>
  </tr>
</template>

