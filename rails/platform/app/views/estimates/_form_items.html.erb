<div class="bg-white shadow rounded-lg p-6">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-medium text-gray-900">内訳明細</h3>
    <button type="button" id="add-item-btn" class="btn-secondary text-sm">
      + 行追加
    </button>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200" id="estimate-items-table">
      <thead class="bg-gray-50">
        <tr>
          <th colspan="7" class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase bg-blue-50 border-r">見積金額</th>
          <th colspan="5" class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase bg-green-50">予算明細</th>
          <th class="px-2 py-2 w-10"></th>
        </tr>
        <tr>
          <th class="px-2 py-2 text-left text-xs font-medium text-gray-500">名称</th>
          <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24">規格</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-20">数量</th>
          <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16">単位</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-24">単価</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-28">金額</th>
          <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 w-24 border-r">備考</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-20 bg-green-50">数量</th>
          <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 w-16 bg-green-50">単位</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-24 bg-green-50">単価</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-28 bg-green-50">金額</th>
          <th class="px-2 py-2 text-right text-xs font-medium text-gray-500 w-16 bg-green-50">日数</th>
          <th class="px-2 py-2 w-10"></th>
        </tr>
      </thead>
      <tbody id="estimate-items-body" class="bg-white divide-y divide-gray-200">
        <%= f.fields_for :estimate_items do |item_f| %>
          <%= render "estimates/item_fields", f: item_f %>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- 諸経費・法定福利費 -->
  <div class="mt-6 bg-gray-50 rounded-lg p-4">
    <table class="w-full text-sm">
      <tbody>
        <tr class="border-b">
          <td class="py-2 w-1/3">1. 直接工事費（税抜）</td>
          <td class="py-2 text-right w-1/3 font-medium" id="direct-cost-display">
            <%= number_to_currency(@estimate.direct_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2 w-1/3"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">
            2. 諸経費
            <span class="ml-2">
              <%= f.number_field :overhead_rate, id: "overhead-rate", step: 0.1, min: 0, max: 100,
                  class: "w-16 rounded border-gray-300 text-sm text-right inline-block" %>
              <span class="text-gray-500">%</span>
            </span>
          </td>
          <td class="py-2 text-right font-medium" id="overhead-cost-display">
            <%= number_to_currency(@estimate.overhead_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">
            3. 法定福利費
            <span class="ml-2">
              <%= f.number_field :welfare_rate, id: "welfare-rate", step: 0.1, min: 0, max: 100,
                  class: "w-16 rounded border-gray-300 text-sm text-right inline-block" %>
              <span class="text-gray-500">%</span>
            </span>
          </td>
          <td class="py-2 text-right font-medium" id="welfare-cost-display">
            <%= number_to_currency(@estimate.welfare_cost, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2">
            4. 端数調整
            <span class="ml-2">
              <%= f.number_field :adjustment, id: "adjustment-input", step: 1,
                  class: "w-24 rounded border-gray-300 text-sm text-right inline-block" %>
              <span class="text-gray-500">円</span>
            </span>
          </td>
          <td class="py-2 text-right font-medium" id="adjustment-display">
            <%= number_to_currency(@estimate.adjustment || 0, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="border-t-2 border-gray-400">
          <td class="py-3 font-medium">合計（税抜）</td>
          <td class="py-3 text-right font-bold text-lg" id="subtotal-display">
            <%= number_to_currency(@estimate.subtotal, unit: "¥", precision: 0) %>
          </td>
          <td class="py-3"></td>
        </tr>
        <tr class="border-b">
          <td class="py-2 text-gray-600">消費税（10%）</td>
          <td class="py-2 text-right font-medium" id="tax-display">
            <%= number_to_currency(@estimate.tax_amount, unit: "¥", precision: 0) %>
          </td>
          <td class="py-2"></td>
        </tr>
        <tr class="bg-blue-50">
          <td class="py-3 font-bold text-blue-900">合計（税込）</td>
          <td class="py-3 text-right font-bold text-xl text-blue-900" id="total-display">
            <%= number_to_currency(@estimate.total_amount, unit: "¥", precision: 0) %>
          </td>
          <td class="py-3"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 予算・粗利サマリー -->
  <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-green-50 rounded-lg">
    <div class="text-center">
      <p class="text-sm text-gray-600">直接工事費</p>
      <p class="text-xl font-bold text-gray-900" id="estimate-subtotal">
        <%= number_to_currency(@estimate.direct_cost, unit: "¥", precision: 0) %>
      </p>
    </div>
    <div class="text-center">
      <p class="text-sm text-gray-600">予算小計</p>
      <p class="text-xl font-bold text-gray-900" id="budget-subtotal">
        <%= number_to_currency(@estimate.budget_total, unit: "¥", precision: 0) %>
      </p>
    </div>
    <div class="text-center">
      <p class="text-sm text-gray-600">粗利（税抜ベース）</p>
      <p class="text-xl font-bold <%= @estimate.gross_profit >= 0 ? 'text-green-600' : 'text-red-600' %>" id="gross-profit">
        <%= number_to_currency(@estimate.gross_profit, unit: "¥", precision: 0) %>
        （<%= @estimate.profit_rate %>%）
      </p>
    </div>
  </div>
</div>

<!-- 行追加用テンプレート -->
<template id="item-row-template">
  <tr class="item-row">
    <td class="px-1 py-1">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][name]"
             class="block w-full rounded border-gray-300 text-sm" placeholder="工種名">
    </td>
    <td class="px-1 py-1">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][specification]"
             class="block w-full rounded border-gray-300 text-sm" placeholder="t=800等">
    </td>
    <td class="px-1 py-1">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][quantity]"
             step="0.01" class="block w-full rounded border-gray-300 text-sm text-right estimate-qty">
    </td>
    <td class="px-1 py-1">
      <select name="estimate[estimate_items_attributes][NEW_INDEX][unit]"
              class="block w-full rounded border-gray-300 text-sm">
        <option value="">-</option>
        <% Estimate::UNIT_OPTIONS.each do |unit| %>
          <option value="<%= unit %>"><%= unit %></option>
        <% end %>
      </select>
    </td>
    <td class="px-1 py-1">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][unit_price]"
             step="1" class="block w-full rounded border-gray-300 text-sm text-right estimate-price">
    </td>
    <td class="px-1 py-1 text-right font-medium estimate-amount">-</td>
    <td class="px-1 py-1 border-r">
      <input type="text" name="estimate[estimate_items_attributes][NEW_INDEX][note]"
             class="block w-full rounded border-gray-300 text-sm">
    </td>
    <td class="px-1 py-1 bg-green-50">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][budget_quantity]"
             step="0.01" class="block w-full rounded border-gray-300 text-sm text-right budget-qty" placeholder="同上">
    </td>
    <td class="px-1 py-1 bg-green-50">
      <select name="estimate[estimate_items_attributes][NEW_INDEX][budget_unit]"
              class="block w-full rounded border-gray-300 text-sm">
        <option value="">同上</option>
        <% Estimate::UNIT_OPTIONS.each do |unit| %>
          <option value="<%= unit %>"><%= unit %></option>
        <% end %>
      </select>
    </td>
    <td class="px-1 py-1 bg-green-50">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][budget_unit_price]"
             step="1" class="block w-full rounded border-gray-300 text-sm text-right budget-price">
    </td>
    <td class="px-1 py-1 text-right font-medium bg-green-50 budget-amount">-</td>
    <td class="px-1 py-1 bg-green-50">
      <input type="number" name="estimate[estimate_items_attributes][NEW_INDEX][construction_days]"
             step="1" class="block w-full rounded border-gray-300 text-sm text-right">
    </td>
    <td class="px-1 py-1">
      <input type="hidden" name="estimate[estimate_items_attributes][NEW_INDEX][sort_order]" value="0">
      <button type="button" class="text-red-500 hover:text-red-700 remove-item-btn">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </td>
  </tr>
</template>

<script>
(function() {
  let itemIndex = <%= @estimate.estimate_items.size %>;
  const tbody = document.getElementById('estimate-items-body');
  const template = document.getElementById('item-row-template');
  const addBtn = document.getElementById('add-item-btn');

  if (!addBtn) return;

  // 行追加
  addBtn.addEventListener('click', function() {
    const newRow = template.content.cloneNode(true);
    const html = newRow.querySelector('tr').outerHTML.replace(/NEW_INDEX/g, itemIndex);
    tbody.insertAdjacentHTML('beforeend', html);
    itemIndex++;
    attachRowEvents();
  });

  // 諸経費・法定福利費・端数調整の変更イベント
  const overheadRate = document.getElementById('overhead-rate');
  const welfareRate = document.getElementById('welfare-rate');
  const adjustmentInput = document.getElementById('adjustment-input');

  if (overheadRate) overheadRate.addEventListener('input', calculateTotals);
  if (welfareRate) welfareRate.addEventListener('input', calculateTotals);
  if (adjustmentInput) adjustmentInput.addEventListener('input', calculateTotals);

  // 行削除・計算イベント
  function attachRowEvents() {
    document.querySelectorAll('.remove-item-btn').forEach(btn => {
      btn.onclick = function() {
        const row = this.closest('tr');
        const destroyInput = row.querySelector('input[name*="_destroy"]');
        if (destroyInput) {
          destroyInput.value = '1';
          row.style.display = 'none';
        } else {
          row.remove();
        }
        calculateTotals();
      };
    });

    document.querySelectorAll('.estimate-qty, .estimate-price').forEach(input => {
      input.oninput = function() {
        const row = this.closest('tr');
        calculateRowAmount(row);
        calculateTotals();
      };
    });

    document.querySelectorAll('.budget-qty, .budget-price').forEach(input => {
      input.oninput = function() {
        const row = this.closest('tr');
        calculateBudgetAmount(row);
        calculateTotals();
      };
    });
  }

  function calculateRowAmount(row) {
    const qty = parseFloat(row.querySelector('.estimate-qty')?.value) || 0;
    const price = parseFloat(row.querySelector('.estimate-price')?.value) || 0;
    const amount = Math.round(qty * price);
    const amountCell = row.querySelector('.estimate-amount');
    if (amountCell) {
      amountCell.textContent = amount > 0 ? '¥' + amount.toLocaleString() : '-';
    }
  }

  function calculateBudgetAmount(row) {
    const budgetQty = parseFloat(row.querySelector('.budget-qty')?.value) || parseFloat(row.querySelector('.estimate-qty')?.value) || 0;
    const budgetPrice = parseFloat(row.querySelector('.budget-price')?.value) || 0;
    const amount = Math.round(budgetQty * budgetPrice);
    const amountCell = row.querySelector('.budget-amount');
    if (amountCell) {
      amountCell.textContent = amount > 0 ? '¥' + amount.toLocaleString() : '-';
    }
  }

  function formatCurrency(amount) {
    return '¥' + Math.round(amount).toLocaleString();
  }

  function calculateTotals() {
    let directCost = 0;
    let budgetTotal = 0;

    document.querySelectorAll('.item-row').forEach(row => {
      if (row.style.display !== 'none') {
        const qty = parseFloat(row.querySelector('.estimate-qty')?.value) || 0;
        const price = parseFloat(row.querySelector('.estimate-price')?.value) || 0;
        directCost += Math.round(qty * price);

        const budgetQty = parseFloat(row.querySelector('.budget-qty')?.value) || qty;
        const budgetPrice = parseFloat(row.querySelector('.budget-price')?.value) || 0;
        budgetTotal += Math.round(budgetQty * budgetPrice);
      }
    });

    // 諸経費・法定福利費・端数調整
    const overheadRateVal = parseFloat(document.getElementById('overhead-rate')?.value) || 0;
    const welfareRateVal = parseFloat(document.getElementById('welfare-rate')?.value) || 0;
    const adjustmentVal = parseInt(document.getElementById('adjustment-input')?.value) || 0;

    const overheadCost = Math.round(directCost * overheadRateVal / 100);
    const welfareCost = Math.round(directCost * welfareRateVal / 100);
    const subtotal = directCost + overheadCost + welfareCost + adjustmentVal;
    const taxAmount = Math.round(subtotal * 0.1);
    const totalAmount = subtotal + taxAmount;

    // 表示更新
    document.getElementById('direct-cost-display').textContent = formatCurrency(directCost);
    document.getElementById('overhead-cost-display').textContent = formatCurrency(overheadCost);
    document.getElementById('welfare-cost-display').textContent = formatCurrency(welfareCost);
    document.getElementById('adjustment-display').textContent = formatCurrency(adjustmentVal);
    document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
    document.getElementById('tax-display').textContent = formatCurrency(taxAmount);
    document.getElementById('total-display').textContent = formatCurrency(totalAmount);

    document.getElementById('estimate-subtotal').textContent = formatCurrency(directCost);
    document.getElementById('budget-subtotal').textContent = formatCurrency(budgetTotal);

    const grossProfit = subtotal - budgetTotal;
    const profitRate = subtotal > 0 ? (grossProfit / subtotal * 100).toFixed(1) : 0;
    const profitEl = document.getElementById('gross-profit');
    profitEl.textContent = formatCurrency(grossProfit) + '（' + profitRate + '%）';
    profitEl.className = 'text-xl font-bold ' + (grossProfit >= 0 ? 'text-green-600' : 'text-red-600');

    // 表紙タブの金額も更新
    const coverDirectCost = document.getElementById('cover-direct-cost');
    if (coverDirectCost) {
      document.getElementById('cover-direct-cost').textContent = formatCurrency(directCost);
      document.getElementById('cover-overhead-rate').textContent = overheadRateVal;
      document.getElementById('cover-overhead-cost').textContent = formatCurrency(overheadCost);
      document.getElementById('cover-welfare-rate').textContent = welfareRateVal;
      document.getElementById('cover-welfare-cost').textContent = formatCurrency(welfareCost);
      document.getElementById('cover-adjustment').textContent = formatCurrency(adjustmentVal);
      document.getElementById('cover-subtotal').textContent = formatCurrency(subtotal);
      document.getElementById('cover-tax').textContent = formatCurrency(taxAmount);
      document.getElementById('cover-total').textContent = formatCurrency(totalAmount);
      document.getElementById('cover-budget-total').textContent = formatCurrency(budgetTotal);
      const coverGrossProfit = document.getElementById('cover-gross-profit');
      coverGrossProfit.textContent = formatCurrency(grossProfit) + '（' + profitRate + '%）';
      coverGrossProfit.className = 'font-medium ' + (grossProfit >= 0 ? 'text-green-600' : 'text-red-600');
    }
  }

  attachRowEvents();
  // 初期計算
  calculateTotals();
})();
</script>
