<div class="bg-white shadow rounded-lg p-6" data-controller="confirmation-template">
  <h3 class="text-lg font-medium text-gray-900 mb-4">工事見積確認書</h3>
  <p class="text-sm text-gray-600 mb-4">工事名: <%= @estimate.subject %></p>

  <%# タブ %>
  <div class="border-b border-gray-200 mb-4">
    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
      <button type="button"
              class="confirmation-tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="input"
              data-action="click->confirmation-template#switchTab">
        入力
      </button>
      <button type="button"
              class="confirmation-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="use"
              data-action="click->confirmation-template#switchTab">
        テンプレートから選択
      </button>
      <button type="button"
              class="confirmation-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="save"
              data-action="click->confirmation-template#switchTab">
        テンプレートとして保存
      </button>
    </nav>
  </div>

  <%# 入力タブ %>
  <div data-confirmation-template-target="tabInput">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200" data-confirmation-template-target="itemsTable">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">項目</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase w-20">貴社</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase w-20">当社</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">備考</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% current_category = nil %>
          <%= f.fields_for :estimate_confirmations do |conf_f| %>
            <% if conf_f.object.item_category != current_category %>
              <% current_category = conf_f.object.item_category %>
              <tr class="bg-gray-100">
                <td colspan="4" class="px-4 py-2 text-sm font-medium text-gray-900">
                  【<%= current_category %>】
                </td>
              </tr>
            <% end %>
            <tr>
              <%= conf_f.hidden_field :id %>
              <%= conf_f.hidden_field :item_category %>
              <%= conf_f.hidden_field :item_name %>
              <%= conf_f.hidden_field :sort_order %>
              <td class="px-4 py-2 text-sm text-gray-900">
                <%= conf_f.object.item_name %>
              </td>
              <td class="px-4 py-2 text-center">
                <%= conf_f.radio_button :responsibility, "client", class: "h-4 w-4 text-blue-600" %>
              </td>
              <td class="px-4 py-2 text-center">
                <%= conf_f.radio_button :responsibility, "company", class: "h-4 w-4 text-blue-600" %>
              </td>
              <td class="px-4 py-2">
                <%= conf_f.text_field :note, class: "block w-full rounded border-gray-300 text-sm", placeholder: "備考" %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <p class="mt-4 text-sm text-gray-500 text-right">○印は負担</p>
  </div>

  <%# テンプレート選択タブ %>
  <div data-confirmation-template-target="tabUse" class="hidden">
    <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mb-4">
      <p class="text-sm text-yellow-800">
        テンプレートを適用するには、新規見積作成時に選択するか、管理画面でデフォルトを変更してください。
      </p>
    </div>
    <div class="space-y-3">
      <%# 新規作成ボタン %>
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-center"
           data-action="click->confirmation-template#showCreateForm">
        <div class="text-center">
          <span class="text-2xl text-gray-400">+</span>
          <p class="text-sm text-gray-500 mt-1">新規テンプレート作成</p>
        </div>
      </div>
      <% @confirmation_templates&.each do |template| %>
        <% items = JSON.parse(template.content) rescue {} %>
        <div class="border rounded-lg p-4 hover:bg-gray-50">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-gray-900"><%= template.name %></span>
            <% if template.shared? %>
              <span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">共有</span>
            <% else %>
              <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">個人</span>
            <% end %>
          </div>
          <p class="text-xs text-gray-500 mb-2">
            カテゴリ: <%= items.keys.join(", ") %>
          </p>
          <p class="text-xs text-gray-400">
            項目数: <%= items.values.flatten.count %>件
          </p>
        </div>
      <% end %>
      <% if @confirmation_templates.blank? %>
        <p class="text-gray-500 text-center py-4">テンプレートがありません</p>
      <% end %>
    </div>
  </div>

  <%# テンプレート保存タブ %>
  <div data-confirmation-template-target="tabSave" class="hidden">
    <p class="text-sm text-gray-600 mb-3">現在の確認書項目をテンプレートとして保存します（カテゴリと項目名のみ）</p>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">テンプレート名</label>
        <input type="text"
               data-confirmation-template-target="templateName"
               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
               placeholder="例: 道路工事_標準">
      </div>
      <% if current_employee.role.in?(%w[admin management]) %>
        <div class="flex items-center gap-2">
          <input type="checkbox" name="confirmation_is_shared" id="confirmation_is_shared" class="h-4 w-4 text-green-600 rounded border-gray-300">
          <label for="confirmation_is_shared" class="text-sm text-gray-700">全社共有テンプレートにする</label>
        </div>
      <% end %>
      <div class="flex items-center gap-4">
        <button type="button"
                data-action="click->confirmation-template#saveAsTemplate"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
          テンプレートとして保存
        </button>
        <span data-confirmation-template-target="saveResult" class="hidden text-green-600 text-sm"></span>
      </div>
    </div>
  </div>
</div>
