<%= form_with model: [@project, @estimate], local: true, class: "space-y-6" do |f| %>
  <% if @estimate.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
      <h3 class="text-red-800 font-medium">入力エラーがあります</h3>
      <ul class="mt-2 text-red-700 text-sm list-disc list-inside">
        <% @estimate.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- タブナビゲーション -->
  <div class="border-b border-gray-200">
    <nav class="-mb-px flex space-x-8" id="estimate-tabs">
      <button type="button" class="tab-link tab-active" onclick="switchEstimateTab('cover', this)">表紙</button>
      <button type="button" class="tab-link tab-inactive" onclick="switchEstimateTab('items', this)">内訳明細</button>
      <button type="button" class="tab-link tab-inactive" onclick="switchEstimateTab('budget', this)">予算明細</button>
      <button type="button" class="tab-link tab-inactive" onclick="switchEstimateTab('confirmation', this)">確認書</button>
      <button type="button" class="tab-link tab-inactive" onclick="switchEstimateTab('conditions', this)">条件書</button>
    </nav>
  </div>

  <!-- タブ1: 表紙 -->
  <div id="tab-cover" class="tab-content">
    <%= render "estimates/form_cover", f: f %>
  </div>

  <!-- タブ2: 内訳明細 -->
  <div id="tab-items" class="tab-content hidden">
    <%= render "estimates/form_items", f: f %>
  </div>

  <!-- タブ3: 予算明細 -->
  <div id="tab-budget" class="tab-content hidden">
    <%= render "estimates/form_budget", f: f %>
  </div>

  <!-- タブ4: 確認書 -->
  <div id="tab-confirmation" class="tab-content hidden">
    <%= render "estimates/form_confirmation", f: f %>
  </div>

  <!-- タブ5: 条件書 -->
  <div id="tab-conditions" class="tab-content hidden">
    <%= render "estimates/form_conditions", f: f %>
  </div>

  <!-- 送信ボタン -->
  <div class="flex justify-end gap-4 pt-4 border-t">
    <%= link_to "キャンセル", @estimate.persisted? ? project_estimate_path(@project, @estimate) : project_estimates_path(@project),
        class: "btn-secondary" %>
    <%= f.submit @estimate.persisted? ? "更新" : "作成", class: "btn-primary" %>
  </div>
<% end %>

<style>
  .tab-link { padding-bottom: 1rem; border-bottom-width: 2px; border-bottom-style: solid; font-weight: 500; font-size: 0.875rem; cursor: pointer; }
  .tab-active { border-color: #3b82f6; color: #3b82f6; }
  .tab-inactive { border-color: transparent; color: #6b7280; }
  .tab-inactive:hover { border-color: #d1d5db; color: #374151; }
</style>

<script>
  // グローバル関数として定義
  window.switchEstimateTab = function(tabName, clickedElement) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(function(content) {
      content.classList.add('hidden');
    });

    // Deactivate all links
    document.querySelectorAll('.tab-link').forEach(function(link) {
      link.classList.remove('tab-active');
      link.classList.add('tab-inactive');
    });

    // Show selected tab
    var tabElement = document.getElementById('tab-' + tabName);
    if (tabElement) {
      tabElement.classList.remove('hidden');
    }

    // Activate clicked link or find the tab button
    if (clickedElement) {
      clickedElement.classList.remove('tab-inactive');
      clickedElement.classList.add('tab-active');
    } else {
      // タブボタンを探してアクティブにする
      var tabButtons = document.querySelectorAll('.tab-link');
      tabButtons.forEach(function(btn) {
        if (btn.textContent.includes(tabName === 'cover' ? '表紙' :
            tabName === 'items' ? '内訳明細' :
            tabName === 'budget' ? '予算明細' :
            tabName === 'confirmation' ? '確認書' : '条件書')) {
          btn.classList.remove('tab-inactive');
          btn.classList.add('tab-active');
        }
      });
    }

    // タブ切り替え時に金額を再計算（表紙・予算タブへの反映を確実にする）
    if (window.recalculateEstimateTotals) {
      window.recalculateEstimateTotals();
    }
    if (window.recalculateBudgetTotals) {
      window.recalculateBudgetTotals();
    }
  };
</script>
