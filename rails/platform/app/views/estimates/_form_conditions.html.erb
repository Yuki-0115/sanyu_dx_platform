<% condition_templates_hash = @condition_templates&.each_with_object({}) { |t, h| h[t.name] = t.content } || {} %>
<div class="bg-white shadow rounded-lg p-6"
     data-controller="condition-template"
     data-condition-template-templates-value="<%= condition_templates_hash.to_json %>">
  <h3 class="text-lg font-medium text-gray-900 mb-4">工事条件書</h3>

  <%# タブ %>
  <div class="border-b border-gray-200 mb-4">
    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
      <button type="button"
              class="condition-tab-btn border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="input"
              data-action="click->condition-template#switchTab">
        入力
      </button>
      <button type="button"
              class="condition-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="use"
              data-action="click->condition-template#switchTab">
        テンプレートから選択
      </button>
      <button type="button"
              class="condition-tab-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"
              data-tab="save"
              data-action="click->condition-template#switchTab">
        テンプレートとして保存
      </button>
    </nav>
  </div>

  <%# 入力タブ %>
  <div data-condition-template-target="tabInput">
    <%= f.label :conditions, "条件内容", class: "block text-sm font-medium text-gray-700 mb-2" %>
    <%= f.text_area :conditions, rows: 12,
        class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm font-mono",
        placeholder: "・産業廃棄物 運搬処分は別途\n・昼間施工 08:00～17:00\n...",
        data: { condition_template_target: "textarea" } %>
  </div>

  <%# テンプレート選択タブ %>
  <div data-condition-template-target="tabUse" class="hidden">
    <p class="text-sm text-gray-600 mb-3">テンプレートを選択すると、入力欄に内容が挿入されます</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <%# 新規作成ボタン %>
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-3 hover:bg-gray-50 cursor-pointer flex items-center justify-center min-h-[80px]"
           data-action="click->condition-template#showCreateForm">
        <div class="text-center">
          <span class="text-2xl text-gray-400">+</span>
          <p class="text-sm text-gray-500 mt-1">新規テンプレート作成</p>
        </div>
      </div>
      <% @condition_templates&.each do |template| %>
        <div class="border rounded-lg p-3 hover:bg-gray-50 cursor-pointer"
             data-action="click->condition-template#insertTemplate"
             data-template-name="<%= template.name %>"
             data-template-content="<%= template.content %>">
          <div class="flex items-center justify-between mb-2">
            <span class="font-medium text-gray-900"><%= template.name %></span>
            <% if template.shared? %>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">共有</span>
            <% else %>
              <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded">個人</span>
            <% end %>
          </div>
          <p class="text-xs text-gray-500 line-clamp-3 whitespace-pre-wrap"><%= template.content.truncate(100) %></p>
        </div>
      <% end %>
      <% if @condition_templates.blank? %>
        <p class="text-gray-500 col-span-2 text-center py-4">テンプレートがありません</p>
      <% end %>
    </div>
  </div>

  <%# テンプレート保存タブ %>
  <div data-condition-template-target="tabSave" class="hidden">
    <p class="text-sm text-gray-600 mb-3">現在の条件内容をテンプレートとして保存します</p>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">テンプレート名</label>
        <input type="text"
               data-condition-template-target="templateName"
               class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
               placeholder="例: 舗装工事_夜間作業">
      </div>
      <% if current_employee.role.in?(%w[admin management]) %>
        <div class="flex items-center gap-2">
          <input type="checkbox" name="is_shared" id="condition_is_shared" class="h-4 w-4 text-blue-600 rounded border-gray-300">
          <label for="condition_is_shared" class="text-sm text-gray-700">全社共有テンプレートにする</label>
        </div>
      <% end %>
      <div class="flex items-center gap-4">
        <button type="button"
                data-action="click->condition-template#saveAsTemplate"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
          テンプレートとして保存
        </button>
        <span data-condition-template-target="saveResult" class="hidden text-green-600 text-sm"></span>
      </div>
    </div>
  </div>
</div>
