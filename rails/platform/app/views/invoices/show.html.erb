<div class="max-w-4xl mx-auto">
  <div class="mb-6 flex justify-between items-start">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">請求書詳細</h1>
      <p class="mt-1 text-sm text-gray-500"><%= @project.name %></p>
    </div>
    <div class="flex space-x-3">
      <% if @invoice.status == "draft" %>
        <%= button_to "発行", issue_project_invoice_path(@project, @invoice),
            method: :post,
            class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" %>
      <% end %>
      <%= link_to pdf_project_invoice_path(@project, @invoice), target: "_blank",
          class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        PDF
      <% end %>
      <% if @invoice.status != "paid" %>
        <%= link_to "編集", edit_project_invoice_path(@project, @invoice),
            class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
      <% end %>
      <%= link_to "一覧へ", project_invoices_path(@project),
          class: "inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" %>
    </div>
  </div>

  <!-- ステータス -->
  <div class="mb-6">
    <% badge_class = case @invoice.status
       when "paid" then "bg-green-100 text-green-800"
       when "issued", "waiting" then "bg-blue-100 text-blue-800"
       when "overdue" then "bg-red-100 text-red-800"
       else "bg-yellow-100 text-yellow-800"
       end %>
    <span class="px-3 py-1 text-sm font-medium rounded-full <%= badge_class %>">
      <%= { "draft" => "下書き", "issued" => "発行済", "waiting" => "入金待ち", "paid" => "入金済", "overdue" => "期限超過" }[@invoice.status] %>
    </span>
  </div>

  <!-- 基本情報 -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">請求情報</h3>
    <dl class="grid grid-cols-2 sm:grid-cols-4 gap-4">
      <div>
        <dt class="text-sm font-medium text-gray-500">請求番号</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @invoice.invoice_number || "-" %></dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">発行日</dt>
        <dd class="mt-1 text-sm text-gray-900"><%= @invoice.issued_date&.strftime("%Y/%m/%d") || "-" %></dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">支払期限</dt>
        <dd class="mt-1 text-sm text-gray-900 <%= @invoice.due_date && @invoice.due_date < Date.current && @invoice.status != 'paid' ? 'text-red-600 font-semibold' : '' %>">
          <%= @invoice.due_date&.strftime("%Y/%m/%d") || "-" %>
        </dd>
      </div>
      <div>
        <dt class="text-sm font-medium text-gray-500">対象年月</dt>
        <dd class="mt-1 text-sm text-gray-900">
          <% if @invoice.progress_year && @invoice.progress_month %>
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
              <%= @invoice.progress_year %>年<%= @invoice.progress_month %>月分
            </span>
          <% else %>
            <span class="text-gray-400">-</span>
          <% end %>
        </dd>
      </div>
    </dl>
  </div>

  <!-- 金額 -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h3 class="text-lg font-medium text-gray-900 mb-4">金額</h3>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg">
      <div class="text-center">
        <dt class="text-xs text-gray-500">税抜金額</dt>
        <dd class="text-lg font-semibold text-gray-900"><%= number_to_currency(@invoice.amount, unit: "¥", precision: 0) %></dd>
      </div>
      <div class="text-center">
        <dt class="text-xs text-gray-500">消費税</dt>
        <dd class="text-lg font-semibold text-gray-900"><%= number_to_currency(@invoice.tax_amount, unit: "¥", precision: 0) %></dd>
      </div>
      <div class="text-center">
        <dt class="text-xs text-gray-500">請求総額</dt>
        <dd class="text-lg font-bold text-blue-600"><%= number_to_currency(@invoice.total_amount, unit: "¥", precision: 0) %></dd>
      </div>
      <div class="text-center">
        <dt class="text-xs text-gray-500">残高</dt>
        <dd class="text-lg font-bold <%= @invoice.remaining_amount > 0 ? 'text-red-600' : 'text-green-600' %>">
          <%= number_to_currency(@invoice.remaining_amount, unit: "¥", precision: 0) %>
        </dd>
      </div>
    </div>
  </div>

  <!-- 入金履歴 -->
  <div class="bg-white shadow rounded-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-medium text-gray-900">入金履歴</h3>
      <% if @invoice.status != "draft" && @invoice.remaining_amount > 0 %>
        <%= link_to new_project_invoice_payment_path(@project, @invoice),
            class: "inline-flex items-center px-3 py-1 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700" do %>
          入金登録
        <% end %>
      <% end %>
    </div>
    <% if @invoice.payments.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">入金日</th>
            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">金額</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">備考</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% @invoice.payments.order(payment_date: :desc).each do |payment| %>
            <tr>
              <td class="px-4 py-2 text-sm text-gray-900"><%= payment.payment_date&.strftime("%Y/%m/%d") %></td>
              <td class="px-4 py-2 text-sm text-gray-900 text-right"><%= number_to_currency(payment.amount, unit: "¥", precision: 0) %></td>
              <td class="px-4 py-2 text-sm text-gray-500"><%= payment.notes&.truncate(50) || "-" %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot class="bg-gray-50">
          <tr>
            <td class="px-4 py-2 text-sm font-medium text-gray-900">合計</td>
            <td class="px-4 py-2 text-sm font-bold text-gray-900 text-right"><%= number_to_currency(@invoice.paid_amount, unit: "¥", precision: 0) %></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    <% else %>
      <p class="text-sm text-gray-500 text-center py-4">入金履歴がありません</p>
    <% end %>
  </div>
</div>
