<%# サイドバー（折りたたみ対応） %>
<aside id="sidebar"
       class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-900 transform transition-all duration-300 ease-in-out -translate-x-full lg:translate-x-0 lg:static lg:inset-auto"
       data-sidebar-target="sidebar">

  <!-- ロゴ・ヘッダー -->
  <div class="flex items-center justify-between h-16 lg:h-14 px-3 bg-gray-800">
    <%= link_to root_path, class: "flex items-center overflow-hidden" do %>
      <%= image_tag "sanyu_logo.png", class: "h-10 w-auto flex-shrink-0", alt: "SanyuTech" %>
    <% end %>
    <!-- モバイル用閉じるボタン -->
    <button type="button" data-action="click->sidebar#close" class="lg:hidden text-gray-400 hover:text-white hover:bg-gray-700 p-3 -m-1 rounded-lg active:bg-gray-600 touch-manipulation">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <!-- PC用折りたたみボタン -->
    <button type="button" data-action="click->sidebar#toggle" class="hidden lg:block text-gray-400 hover:text-white p-1" title="サイドバーを折りたたむ">
      <svg class="w-5 h-5" data-sidebar-target="collapseIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
      </svg>
    </button>
  </div>

  <!-- ナビゲーション -->
  <nav class="mt-2 px-2 space-y-1 overflow-y-auto scrollbar-thin" style="max-height: calc(100vh - 3.5rem);" data-controller="sidebar-menu">
    <% current_date = Date.current %>

    <!-- ========== 経営 ========== -->
    <div>
      <button type="button" data-action="click->sidebar-menu#toggle" data-section="management"
              class="w-full flex items-center justify-between px-4 py-3 lg:px-3 lg:py-2.5 text-base lg:text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
        <div class="flex items-center">
          <svg class="w-6 h-6 lg:w-5 lg:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          <span class="ml-3">経営</span>
        </div>
        <svg data-sidebar-menu-target="arrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      <div data-sidebar-menu-target="section" data-section-id="management" class="hidden ml-4 mt-1 space-y-1">
        <%= link_to root_path,
            class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'dashboard' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}",
            title: "ダッシュボード" do %>
          <span>ダッシュボード</span>
        <% end %>
        <% if current_employee.can_access?(:management_dashboard) %>
          <%= link_to management_dashboard_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'management_dashboard' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}",
              title: "経営分析" do %>
            <span>経営分析</span>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- ========== 営業・工務 ========== -->
    <div>
      <button type="button" data-action="click->sidebar-menu#toggle" data-section="sales"
              class="w-full flex items-center justify-between px-4 py-3 lg:px-3 lg:py-2.5 text-base lg:text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
        <div class="flex items-center">
          <svg class="w-6 h-6 lg:w-5 lg:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
          </svg>
          <span class="ml-3">営業・工務</span>
        </div>
        <svg data-sidebar-menu-target="arrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      <div data-sidebar-menu-target="section" data-section-id="sales" class="hidden ml-4 mt-1 space-y-1">
        <% if current_employee.can_access?(:projects) %>
          <%= link_to projects_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'projects' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>案件</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:schedule) %>
          <%= link_to schedule_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'schedule' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>段取り</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:daily_reports) %>
          <%= link_to all_daily_reports_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'all_daily_reports' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>日報</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:attendance_sheets) %>
          <%= link_to attendance_sheets_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'attendance_sheets' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>勤怠</span>
          <% end %>
        <% end %>
        <%= link_to expense_reports_path,
            class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'expense_reports' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
          <span>経費報告</span>
        <% end %>
        <% if current_employee.can_access?(:accounting) %>
          <%= link_to monthly_progresses_path(year: current_date.year, month: current_date.month),
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_progresses' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>出来高入力</span>
          <% end %>
          <%= link_to monthly_profit_losses_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_profit_losses' || controller_name == 'monthly_fixed_costs' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>月次損益</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:invoices) %>
          <%= link_to all_invoices_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'all_invoices' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>請求</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:offsets) %>
          <%= link_to offsets_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'offsets' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>相殺</span>
          <% end %>
        <% end %>
        <% pending_leave_count_sales = current_employee.admin? || current_employee.management? ? PaidLeaveRequest.pending.count : 0 %>
        <%= link_to paid_leave_requests_path,
            class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'paid_leave_requests' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
          <span class="flex items-center">
            有給申請
            <% if pending_leave_count_sales > 0 %>
              <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                <%= pending_leave_count_sales %>
              </span>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>

    <!-- ========== 経理 ========== -->
    <% if current_employee.can_access?(:accounting) %>
      <div>
        <button type="button" data-action="click->sidebar-menu#toggle" data-section="accounting"
                class="w-full flex items-center justify-between px-4 py-3 lg:px-3 lg:py-2.5 text-base lg:text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
          <div class="flex items-center">
            <svg class="w-6 h-6 lg:w-5 lg:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            <span class="ml-3">経理</span>
          </div>
          <svg data-sidebar-menu-target="arrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        <div data-sidebar-menu-target="section" data-section-id="accounting" class="hidden ml-4 mt-1 space-y-1">
          <% if current_employee.can_access?(:projects) %>
            <%= link_to projects_path,
                class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'projects' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
              <span>案件</span>
            <% end %>
          <% end %>
          <%= link_to monthly_income_statement_path(year: current_date.year, month: current_date.month),
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_income_statements' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>損益計算書</span>
          <% end %>
          <%= link_to monthly_admin_expenses_path(year: current_date.year, month: current_date.month),
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_admin_expenses' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>販管費</span>
          <% end %>
          <%= link_to monthly_salaries_path(year: current_date.year, month: current_date.month),
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_salaries' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>確定給与</span>
          <% end %>
          <%= link_to monthly_outsourcing_costs_path(year: current_date.year, month: current_date.month),
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'monthly_outsourcing_costs' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>確定外注費</span>
          <% end %>
          <%= link_to provisional_expenses_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'provisional_expenses' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>仮経費確定</span>
          <% end %>
          <%= link_to accounting_expenses_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'accounting/expenses' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>経費処理</span>
          <% end %>
          <%= link_to accounting_reimbursements_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'accounting/reimbursements' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>立替精算</span>
          <% end %>
          <% if current_employee.can_access?(:cash_flow) %>
            <%= link_to cash_flow_calendar_path,
                class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'cash_flow_calendar' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
              <span>資金繰り表</span>
            <% end %>
            <%= link_to master_fixed_expense_schedules_path,
                class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/fixed_expense_schedules' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
              <span>固定費</span>
            <% end %>
            <%= link_to master_payment_terms_path,
                class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/payment_terms' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
              <span>支払サイト</span>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- ========== 事務 ========== -->
    <div>
      <button type="button" data-action="click->sidebar-menu#toggle" data-section="admin"
              class="w-full flex items-center justify-between px-4 py-3 lg:px-3 lg:py-2.5 text-base lg:text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
        <div class="flex items-center">
          <svg class="w-6 h-6 lg:w-5 lg:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span class="ml-3">事務</span>
        </div>
        <svg data-sidebar-menu-target="arrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>
      <div data-sidebar-menu-target="section" data-section-id="admin" class="hidden ml-4 mt-1 space-y-1">
        <% if current_employee.can_access?(:projects) %>
          <%= link_to projects_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'projects' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>案件</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:safety_documents) %>
          <%= link_to safety_documents_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'safety_documents' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>安全書類</span>
          <% end %>
        <% end %>
        <% if current_employee.can_access?(:master) %>
          <%= link_to paid_leaves_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'paid_leaves' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>有給管理</span>
          <% end %>
        <% end %>
        <% pending_leave_count = current_employee.admin? || current_employee.management? ? PaidLeaveRequest.pending.count : 0 %>
        <%= link_to paid_leave_requests_path,
            class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'paid_leave_requests' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
          <span class="flex items-center">
            有給申請
            <% if pending_leave_count > 0 %>
              <span class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-600 rounded-full">
                <%= pending_leave_count %>
              </span>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>

    <!-- ========== 共通 ========== -->
    <% if current_employee.can_access?(:master) %>
      <div>
        <button type="button" data-action="click->sidebar-menu#toggle" data-section="common"
                class="w-full flex items-center justify-between px-4 py-3 lg:px-3 lg:py-2.5 text-base lg:text-sm font-medium text-gray-300 hover:bg-gray-800 hover:text-white rounded-lg transition-colors">
          <div class="flex items-center">
            <svg class="w-6 h-6 lg:w-5 lg:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
            </svg>
            <span class="ml-3">共通</span>
          </div>
          <svg data-sidebar-menu-target="arrow" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </button>
        <div data-sidebar-menu-target="section" data-section-id="common" class="hidden ml-4 mt-1 space-y-1">
          <%= link_to master_clients_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/clients' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>顧客</span>
          <% end %>
          <%= link_to master_partners_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/partners' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>協力会社</span>
          <% end %>
          <%= link_to master_employees_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/employees' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>社員</span>
          <% end %>
          <%= link_to master_company_holidays_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_path == 'master/company_holidays' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>休日</span>
          <% end %>
          <%= link_to estimate_templates_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'estimate_templates' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>見積テンプレート</span>
          <% end %>
          <%= link_to data_imports_path,
              class: "flex items-center px-4 py-2 text-sm transition-colors rounded-lg #{controller_name == 'data_imports' ? 'bg-gray-800 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}" do %>
            <span>データ取込</span>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- ログアウト -->
    <div class="mt-4 pt-4 border-t border-gray-700">
      <div class="px-4 lg:px-3 py-2">
        <p class="text-xs text-gray-400 mb-1 truncate"><%= current_employee.name %></p>
        <%= link_to destroy_employee_session_path, data: { turbo_method: :delete },
            class: "flex items-center w-full px-4 py-2 text-sm text-gray-300 hover:bg-gray-800 hover:text-white transition-colors rounded-lg" do %>
          <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
          <span class="ml-3">ログアウト</span>
        <% end %>
      </div>
    </div>
  </nav>
</aside>

<!-- オーバーレイ（モバイル用） -->
<div id="sidebar-overlay"
     class="fixed inset-0 bg-black bg-opacity-50 z-20 opacity-0 pointer-events-none transition-opacity duration-300 lg:hidden"
     data-sidebar-target="overlay"
     data-action="click->sidebar#close"></div>
