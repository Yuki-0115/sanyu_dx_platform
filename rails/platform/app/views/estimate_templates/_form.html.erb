<%= form_with model: template, class: "space-y-6", data: { controller: "template-editor", template_editor_type_value: template.template_type } do |f| %>
  <% if template.errors.any? %>
    <div class="bg-red-50 border border-red-200 rounded p-4">
      <p class="text-red-800 font-medium">入力エラーがあります</p>
      <ul class="mt-2 text-sm text-red-600 list-disc list-inside">
        <% template.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="bg-white shadow rounded-lg p-6 space-y-6">
    <%= f.hidden_field :template_type %>
    <%= f.hidden_field :content, data: { template_editor_target: "hiddenContent" } %>

    <div>
      <%= f.label :name, "テンプレート名", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.text_field :name,
          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
          placeholder: template.template_type == "condition" ? "舗装工事_標準" : "材料費確認_標準" %>
    </div>

    <% if template.template_type == "condition" %>
      <%# 条件書: 項目リスト %>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">条件項目</label>
        <div data-template-editor-target="conditionItems" class="space-y-2">
          <% if template.content.present? %>
            <% template.content.split("\n").each do |line| %>
              <% next if line.blank? %>
              <div class="flex items-center gap-2 mb-2">
                <span class="text-gray-400">・</span>
                <input type="text" value="<%= line.strip %>"
                       class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                       data-action="input->template-editor#updateHiddenContent"
                       placeholder="条件を入力">
                <button type="button" data-action="click->template-editor#removeConditionItem"
                        class="text-red-500 hover:text-red-700 p-1">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
            <% end %>
          <% end %>
        </div>
        <button type="button" data-action="click->template-editor#addConditionItem"
                class="mt-3 text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          条件を追加
        </button>
      </div>

    <% else %>
      <%# 確認書: カテゴリと項目 %>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">確認項目</label>
        <div data-template-editor-target="confirmationCategories">
          <% if template.content.present? %>
            <% begin %>
              <% JSON.parse(template.content).each do |category, items| %>
                <div class="border rounded-lg p-4 mb-4 bg-gray-50" data-category="">
                  <div class="flex items-center gap-2 mb-3">
                    <input type="text" value="<%= category %>"
                           class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 font-medium"
                           data-action="input->template-editor#updateHiddenContent"
                           data-role="category-name"
                           placeholder="カテゴリ名（例: 材料費）">
                    <button type="button" data-action="click->template-editor#removeCategory"
                            class="text-red-500 hover:text-red-700 p-1" title="カテゴリを削除">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                  <div data-role="items-container" class="space-y-2 ml-4">
                    <% items.each do |item| %>
                      <div class="flex items-center gap-2">
                        <span class="text-gray-400 text-sm">-</span>
                        <input type="text" value="<%= item %>"
                               class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"
                               data-action="input->template-editor#updateHiddenContent"
                               data-role="item-name"
                               placeholder="項目名">
                        <button type="button" data-action="click->template-editor#removeItem"
                                class="text-red-400 hover:text-red-600 p-1">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                          </svg>
                        </button>
                      </div>
                    <% end %>
                  </div>
                  <button type="button" data-action="click->template-editor#addItem"
                          class="mt-2 ml-4 text-sm text-blue-600 hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    項目を追加
                  </button>
                </div>
              <% end %>
            <% rescue JSON::ParserError %>
              <%# JSONパースエラー時は空で開始 %>
            <% end %>
          <% end %>
        </div>
        <button type="button" data-action="click->template-editor#addCategory"
                class="mt-3 text-sm text-green-600 hover:text-green-800 flex items-center gap-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          カテゴリを追加
        </button>
      </div>
    <% end %>

    <% if can_manage_shared? %>
      <div class="flex items-center gap-2">
        <%= f.check_box :is_shared, class: "h-4 w-4 text-blue-600 rounded border-gray-300" %>
        <%= f.label :is_shared, "全社共有テンプレートにする", class: "text-sm text-gray-700" %>
        <span class="text-xs text-gray-500">（管理者のみ設定可能）</span>
      </div>
    <% end %>

    <div>
      <%= f.label :sort_order, "並び順", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= f.number_field :sort_order, min: 0,
          class: "block w-32 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
          placeholder: "0" %>
      <p class="mt-1 text-xs text-gray-500">小さい数字が先に表示されます</p>
    </div>
  </div>

  <div class="flex justify-end gap-4">
    <%= link_to "キャンセル", estimate_templates_path,
        class: "px-6 py-2 bg-gray-300 rounded hover:bg-gray-400" %>
    <%= f.submit template.persisted? ? "更新" : "作成",
        class: "px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 cursor-pointer" %>
  </div>
<% end %>
