<div class="space-y-6">
  <%# ヘッダー %>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">現場台帳</h1>
      <p class="mt-1 text-sm text-gray-500">
        <%= @project.code %> - <%= @project.name %>
      </p>
    </div>
    <div class="flex items-center space-x-3">
      <%= link_to project_path(@project),
          class: "inline-flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
        </svg>
        案件に戻る
      <% end %>
    </div>
  </div>

  <%# 注意書き %>
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start">
      <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <p class="text-sm text-blue-800">
          <strong>日報の直接入力値</strong>を集計しています（現場からのリアルタイム報告値）。
          確定原価は月次損益で確認してください。
        </p>
      </div>
    </div>
  </div>

  <%# サマリーカード %>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
    <%# 受注金額 %>
    <div class="bg-white rounded-lg shadow p-4">
      <dt class="text-sm font-medium text-gray-500">受注金額</dt>
      <dd class="mt-1 text-2xl font-bold text-gray-900">
        <%= @project.order_amount ? number_to_currency(@project.order_amount, unit: "¥", precision: 0) : "未設定" %>
      </dd>
    </div>

    <%# 原価合計 %>
    <div class="bg-white rounded-lg shadow p-4">
      <dt class="text-sm font-medium text-gray-500">原価合計（概算）</dt>
      <dd class="mt-1 text-2xl font-bold text-gray-900">
        <%= number_to_currency(@project.site_ledger_total_cost, unit: "¥", precision: 0) %>
      </dd>
      <% if @budget %>
        <% variance = @project.site_ledger_budget_variance[:total] %>
        <p class="text-xs mt-1 <%= variance >= 0 ? 'text-green-600' : 'text-red-600' %>">
          予算比: <%= variance >= 0 ? '+' : '' %><%= number_to_currency(variance, unit: "¥", precision: 0) %>
        </p>
      <% end %>
    </div>

    <%# 粗利 %>
    <div class="bg-white rounded-lg shadow p-4">
      <dt class="text-sm font-medium text-gray-500">粗利（概算）</dt>
      <% gross = @project.site_ledger_gross_profit %>
      <dd class="mt-1 text-2xl font-bold <%= gross && gross >= 0 ? 'text-green-600' : 'text-red-600' %>">
        <%= gross ? number_to_currency(gross, unit: "¥", precision: 0) : "-" %>
      </dd>
    </div>

    <%# 利益率 %>
    <div class="bg-white rounded-lg shadow p-4">
      <dt class="text-sm font-medium text-gray-500">利益率（概算）</dt>
      <% rate = @project.site_ledger_profit_rate %>
      <dd class="mt-1 text-2xl font-bold <%= rate && rate >= 0 ? 'text-green-600' : 'text-red-600' %>">
        <%= rate ? "#{rate}%" : "-" %>
      </dd>
      <% if @budget&.target_profit_rate %>
        <p class="text-xs text-gray-500 mt-1">目標: <%= @budget.target_profit_rate %>%</p>
      <% end %>
    </div>
  </div>

  <%# 原価内訳 %>
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-4 py-3 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">原価内訳（日報入力値）</h3>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">項目</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">金額</th>
            <% if @budget %>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">予算</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">予算比</th>
            <% end %>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% variance = @project.site_ledger_budget_variance %>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
              労務費
              <span class="text-xs text-gray-400 ml-1">（<%= number_with_precision(@project.site_ledger_regular_man_days, precision: 1) %>人工 × ¥<%= @project.regular_labor_unit_price.to_fs(:delimited) %>）</span>
            </td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_labor_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-500">
                <%= number_to_currency(@budget.labor_cost || 0, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right <%= variance[:labor].to_i >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= variance[:labor].to_i >= 0 ? '+' : '' %><%= number_to_currency(variance[:labor] || 0, unit: "¥", precision: 0) %>
              </td>
            <% end %>
          </tr>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">材料費</td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_material_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-500">
                <%= number_to_currency(@budget.material_cost || 0, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right <%= variance[:material].to_i >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= variance[:material].to_i >= 0 ? '+' : '' %><%= number_to_currency(variance[:material] || 0, unit: "¥", precision: 0) %>
              </td>
            <% end %>
          </tr>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">
              外注費（人工）
              <span class="text-xs text-gray-400 ml-1">（<%= number_with_precision(@project.site_ledger_outsourcing_man_days, precision: 1) %>人工 × ¥<%= @project.outsourcing_unit_price.to_fs(:delimited) %>）</span>
            </td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_outsourcing_man_days_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
            <% end %>
          </tr>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">外注費（請負出来高）</td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_outsourcing_contract_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
            <% end %>
          </tr>

          <tr class="bg-orange-50">
            <td class="px-4 py-3 text-sm font-medium text-gray-900 pl-6">外注費 小計</td>
            <td class="px-4 py-3 text-sm text-right font-bold text-gray-900">
              <%= number_to_currency(@project.site_ledger_outsourcing_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-500">
                <%= number_to_currency(@budget.outsourcing_cost || 0, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right <%= variance[:outsourcing].to_i >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= variance[:outsourcing].to_i >= 0 ? '+' : '' %><%= number_to_currency(variance[:outsourcing] || 0, unit: "¥", precision: 0) %>
              </td>
            <% end %>
          </tr>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">運搬費</td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_transportation_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
              <td class="px-4 py-3 text-sm text-right text-gray-400">-</td>
            <% end %>
          </tr>

          <tr>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">ガソリン・高速代</td>
            <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
              <%= number_to_currency(@project.site_ledger_expense_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-500">
                <%= number_to_currency(@budget.expense_cost || 0, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right <%= variance[:expense].to_i >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= variance[:expense].to_i >= 0 ? '+' : '' %><%= number_to_currency(variance[:expense] || 0, unit: "¥", precision: 0) %>
              </td>
            <% end %>
          </tr>

          <%# 合計 %>
          <tr class="bg-gray-50 font-bold">
            <td class="px-4 py-3 text-sm text-gray-900">合計</td>
            <td class="px-4 py-3 text-sm text-right text-gray-900">
              <%= number_to_currency(@project.site_ledger_total_cost, unit: "¥", precision: 0) %>
            </td>
            <% if @budget %>
              <td class="px-4 py-3 text-sm text-right text-gray-500">
                <%= number_to_currency(@budget.total_cost || 0, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right <%= variance[:total].to_i >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= variance[:total].to_i >= 0 ? '+' : '' %><%= number_to_currency(variance[:total] || 0, unit: "¥", precision: 0) %>
              </td>
            <% end %>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <%# 勤怠情報（参考） %>
  <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
    <h4 class="text-sm font-medium text-gray-700 mb-3">勤怠情報（参考）</h4>
    <div class="grid grid-cols-3 gap-4 text-sm">
      <div>
        <span class="text-gray-500">正社員:</span>
        <strong class="ml-1"><%= number_with_precision(@project.site_ledger_regular_man_days, precision: 1) %> 人工</strong>
      </div>
      <div>
        <span class="text-gray-500">仮社員:</span>
        <strong class="ml-1"><%= number_with_precision(@project.site_ledger_temporary_man_days, precision: 1) %> 人工</strong>
        <span class="text-xs text-gray-400">（相殺用）</span>
      </div>
      <div>
        <span class="text-gray-500">外注:</span>
        <strong class="ml-1"><%= number_with_precision(@project.site_ledger_outsourcing_man_days, precision: 1) %> 人工</strong>
      </div>
    </div>
  </div>

  <%# 日別明細 %>
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-4 py-3 border-b border-gray-200">
      <h3 class="text-lg font-medium text-gray-900">日別明細</h3>
    </div>
    <% if @daily_summary.any? %>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">日付</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">労務費</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">材料費</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">外注費</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">運搬費</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">燃料・高速</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">小計</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase"></th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <% @daily_summary.each do |day| %>
              <% expense_cost = day[:fuel_cost] + day[:highway_cost] %>
              <% subtotal = day[:labor_cost] + day[:material_cost] + day[:outsourcing_cost] + day[:transportation_cost] + expense_cost %>
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm text-gray-900">
                  <%= day[:date].strftime("%Y/%m/%d (%a)") %>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">
                  <%= number_to_currency(day[:labor_cost], unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">
                  <%= number_to_currency(day[:material_cost], unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">
                  <%= number_to_currency(day[:outsourcing_cost], unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">
                  <%= number_to_currency(day[:transportation_cost], unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-sm text-right text-gray-700">
                  <%= number_to_currency(expense_cost, unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-sm text-right font-medium text-gray-900">
                  <%= number_to_currency(subtotal, unit: "¥", precision: 0) %>
                </td>
                <td class="px-4 py-3 text-center">
                  <%= link_to project_daily_report_path(@project, day[:report]),
                      class: "text-blue-600 hover:text-blue-800 text-sm" do %>
                    詳細
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
          <tfoot class="bg-gray-50">
            <tr class="font-bold">
              <td class="px-4 py-3 text-sm text-gray-900">合計</td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <%= number_to_currency(@daily_summary.sum { |d| d[:labor_cost] }, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <%= number_to_currency(@daily_summary.sum { |d| d[:material_cost] }, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <%= number_to_currency(@daily_summary.sum { |d| d[:outsourcing_cost] }, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <%= number_to_currency(@daily_summary.sum { |d| d[:transportation_cost] }, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <%= number_to_currency(@daily_summary.sum { |d| d[:fuel_cost] + d[:highway_cost] }, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3 text-sm text-right text-gray-900">
                <% total = @daily_summary.sum { |d| d[:labor_cost] + d[:material_cost] + d[:outsourcing_cost] + d[:transportation_cost] + d[:fuel_cost] + d[:highway_cost] } %>
                <%= number_to_currency(total, unit: "¥", precision: 0) %>
              </td>
              <td class="px-4 py-3"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    <% else %>
      <div class="p-8 text-center text-gray-500">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
        </svg>
        <p class="mt-2">確定済みの日報がありません</p>
        <%= link_to "日報を作成", new_project_daily_report_path(@project),
            class: "mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700" %>
      </div>
    <% end %>
  </div>
</div>
