<div class="max-w-full mx-auto py-4 sm:py-6 px-2 sm:px-4" data-controller="dandori" data-dandori-refresh-interval-value="30000">
  <!-- ヘッダー -->
  <div class="mb-4 sm:mb-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
      <div class="flex items-center gap-3">
        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">段取り表</h2>
        <button type="button" data-action="click->dandori#openBulkModal"
                class="hidden sm:inline-flex items-center px-3 py-1.5 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
          <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
          </svg>
          一括配置
        </button>
      </div>

      <!-- ナビゲーション -->
      <div class="flex items-center justify-between sm:justify-end space-x-1 sm:space-x-2">
        <%= link_to schedule_path(week: (@current_week_start - 7.days).strftime("%Y-%m-%d")),
            class: "p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
        <% end %>
        <span class="text-sm sm:text-lg font-semibold px-2 sm:px-4 text-center flex-1 sm:flex-none">
          <span class="hidden sm:inline"><%= l(@current_week_start, format: "%Y年%m月%d日") %> 〜 <%= l(@current_week_start + 6.days, format: "%m月%d日") %></span>
          <span class="sm:hidden"><%= l(@current_week_start, format: "%m/%d") %>〜<%= l(@current_week_start + 6.days, format: "%m/%d") %></span>
        </span>
        <%= link_to schedule_path(week: (@current_week_start + 7.days).strftime("%Y-%m-%d")),
            class: "p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-200 rounded-lg" do %>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        <% end %>
        <%= link_to "今週", schedule_path, class: "ml-2 px-2 sm:px-3 py-1 text-xs sm:text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700" %>
      </div>
    </div>
  </div>

  <!-- 残り人員表示エリア -->
  <div data-dandori-target="availableWorkers" class="mb-3 p-2 sm:p-3 bg-gray-50 rounded-lg min-h-8 text-sm">
    <span class="text-gray-500">日付をクリックすると残り人員を表示</span>
  </div>

  <!-- 凡例 -->
  <details class="mb-3 sm:mb-4 sm:open">
    <summary class="sm:hidden text-sm text-gray-600 cursor-pointer mb-2">凡例を表示</summary>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-4 text-xs sm:text-sm">
      <div class="flex items-center gap-2 sm:gap-4 flex-wrap">
        <span class="font-medium text-gray-700">凡例:</span>
        <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded font-medium bg-orange-100 text-orange-800">日勤</span>
        <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded font-medium bg-indigo-100 text-indigo-800">夜勤</span>
        <span class="text-red-600 font-bold">赤字</span>
        <span class="text-gray-500">= 日勤夜勤重複</span>
        <span class="text-amber-500">★</span>
        <span class="text-gray-500">= 職長</span>
      </div>
      <div class="flex items-center gap-1.5 sm:gap-2 flex-wrap">
        <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded font-medium bg-blue-100 text-blue-700 border border-blue-300">正</span>
        <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded font-medium bg-yellow-100 text-yellow-700 border border-yellow-300">仮</span>
        <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded font-medium bg-purple-100 text-purple-700 border border-purple-300">外</span>
      </div>
    </div>
  </details>

  <!-- 段取り表本体 -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="overflow-x-auto -webkit-overflow-scrolling-touch">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="sticky left-0 z-10 bg-gray-50 px-2 sm:px-4 py-2 sm:py-3 text-left text-xs sm:text-sm font-medium text-gray-700 border-r min-w-28 sm:min-w-52">
              案件名
            </th>
            <% @week_dates.each_with_index do |date, i| %>
              <%
                is_today = date == Date.current
                is_sunday = i == 0
                is_saturday = i == 6
                remaining = @remaining_by_date[date] || { day: 0, night: 0 }
                date_label = l(date, format: "%m/%d(%a)")
              %>
              <th class="px-0.5 sm:px-1 py-1 sm:py-2 text-center text-xs sm:text-sm font-medium min-w-14 sm:min-w-28 border-r cursor-pointer hover:bg-gray-100 <%= is_today ? 'bg-blue-50' : '' %> <%= is_sunday ? 'text-red-600' : (is_saturday ? 'text-blue-600' : 'text-gray-700') %>"
                  data-action="click->dandori#showAvailableWorkers"
                  data-date="<%= date.strftime('%Y-%m-%d') %>"
                  data-date-label="<%= date_label %>">
                <div class="text-xs"><%= %w[日 月 火 水 木 金 土][i] %></div>
                <div class="text-sm sm:text-lg font-bold"><%= date.day %></div>
                <% if is_today %>
                  <span class="hidden sm:inline-block text-xs bg-blue-600 text-white px-1 rounded">今日</span>
                <% end %>
                <div class="mt-0.5 sm:mt-1 text-xs">
                  <span class="text-orange-600"><%= remaining[:day] %></span>
                  <span class="text-gray-400">/</span>
                  <span class="text-indigo-600"><%= remaining[:night] %></span>
                </div>
              </th>
            <% end %>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <% @projects.each do |project| %>
            <tr class="hover:bg-gray-50">
              <!-- 案件名 -->
              <td class="sticky left-0 z-10 bg-white px-2 sm:px-3 py-1 sm:py-2 border-r">
                <div class="min-w-0 flex items-center justify-between">
                  <div class="flex-1 min-w-0">
                    <%= link_to project.name, project_path(project), class: "text-xs sm:text-sm font-medium text-blue-600 hover:underline block truncate", title: project.name %>
                    <p class="text-xs text-gray-500 truncate hidden sm:block"><%= project.client&.name %></p>
                  </div>
                </div>
              </td>
              <!-- 各日の配置 -->
              <% @week_dates.each_with_index do |date, i| %>
                <%
                  is_today = date == Date.current
                  day_schedules = @schedule_map[[project.id, date, "day"]] || []
                  night_schedules = @schedule_map[[project.id, date, "night"]] || []
                  overlapping_ids = @overlapping_employees[date] || Set.new
                  note = @notes_map[[project.id, date]]
                  has_note = note&.has_content?
                  date_label = l(date, format: "%m/%d(%a)")
                %>
                <td class="px-0.5 sm:px-1 py-0.5 sm:py-1 text-center border-r <%= is_today ? 'bg-blue-50' : '' %>"
                    data-project-id="<%= project.id %>"
                    data-date="<%= date.strftime('%Y-%m-%d') %>">
                  <div class="min-h-12 sm:min-h-20 flex flex-col">
                    <!-- 日勤セル -->
                    <div class="flex-1 bg-orange-50 border-b border-orange-200 rounded-t px-0.5 py-0.5 relative">
                      <div class="cursor-pointer hover:ring-2 hover:ring-orange-300 transition-all min-h-6"
                           data-action="click->dandori#openCellModal"
                           data-project-id="<%= project.id %>"
                           data-project-name="<%= project.name %>"
                           data-date="<%= date.strftime('%Y-%m-%d') %>"
                           data-date-label="<%= date_label %>"
                           data-shift="day">
                        <% if day_schedules.any? %>
                          <div class="flex flex-wrap gap-0.5 justify-center">
                            <% day_schedules.take(4).each do |s| %>
                              <% is_overlapping = overlapping_ids.include?(s.employee_id) %>
                              <% is_foreman = s.role == "foreman" %>
                              <span class="text-xs <%= is_overlapping ? 'text-red-600 font-bold' : '' %>"
                                    title="<%= s.employee.name %><%= is_foreman ? '(職長)' : '' %> 日勤<%= is_overlapping ? ' ※夜勤と重複' : '' %>">
                                <%= is_foreman ? '★' : '' %><%= s.employee.name.first(2) %>
                              </span>
                            <% end %>
                            <% if day_schedules.size > 4 %>
                              <span class="text-xs text-gray-500">+<%= day_schedules.size - 4 %></span>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="text-xs text-orange-300">-</span>
                        <% end %>
                      </div>
                      <!-- 日勤備考ボタン -->
                      <button type="button"
                              class="absolute bottom-0 right-0 p-0.5 <%= has_note ? 'text-amber-500' : 'text-gray-300 hover:text-gray-400' %>"
                              data-action="click->dandori#openNoteModal"
                              data-project-id="<%= project.id %>"
                              data-project-name="<%= project.name %>"
                              data-date="<%= date.strftime('%Y-%m-%d') %>"
                              data-date-label="<%= date_label %>"
                              title="<%= has_note ? '備考（入力あり）' : '備考' %>">
                        <svg class="w-3 h-3" fill="<%= has_note ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                      </button>
                    </div>
                    <!-- 夜勤セル -->
                    <div class="flex-1 bg-indigo-50 rounded-b px-0.5 py-0.5 relative">
                      <div class="cursor-pointer hover:ring-2 hover:ring-indigo-300 transition-all min-h-6"
                           data-action="click->dandori#openCellModal"
                           data-project-id="<%= project.id %>"
                           data-project-name="<%= project.name %>"
                           data-date="<%= date.strftime('%Y-%m-%d') %>"
                           data-date-label="<%= date_label %>"
                           data-shift="night">
                        <% if night_schedules.any? %>
                          <div class="flex flex-wrap gap-0.5 justify-center">
                            <% night_schedules.take(4).each do |s| %>
                              <% is_overlapping = overlapping_ids.include?(s.employee_id) %>
                              <% is_foreman = s.role == "foreman" %>
                              <span class="text-xs <%= is_overlapping ? 'text-red-600 font-bold' : '' %>"
                                    title="<%= s.employee.name %><%= is_foreman ? '(職長)' : '' %> 夜勤<%= is_overlapping ? ' ※日勤と重複' : '' %>">
                                <%= is_foreman ? '★' : '' %><%= s.employee.name.first(2) %>
                              </span>
                            <% end %>
                            <% if night_schedules.size > 4 %>
                              <span class="text-xs text-gray-500">+<%= night_schedules.size - 4 %></span>
                            <% end %>
                          </div>
                        <% else %>
                          <span class="text-xs text-indigo-300">-</span>
                        <% end %>
                      </div>
                      <!-- 夜勤備考ボタン -->
                      <button type="button"
                              class="absolute bottom-0 right-0 p-0.5 <%= has_note ? 'text-amber-500' : 'text-gray-300 hover:text-gray-400' %>"
                              data-action="click->dandori#openNoteModal"
                              data-project-id="<%= project.id %>"
                              data-project-name="<%= project.name %>"
                              data-date="<%= date.strftime('%Y-%m-%d') %>"
                              data-date-label="<%= date_label %>"
                              title="<%= has_note ? '備考（入力あり）' : '備考' %>">
                        <svg class="w-3 h-3" fill="<%= has_note ? 'currentColor' : 'none' %>" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </td>
              <% end %>
            </tr>
          <% end %>
          <% if @projects.empty? %>
            <tr>
              <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                進行中の案件がありません
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- セルモーダル（人員配置） -->
  <div data-dandori-target="cellModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 pt-4 pb-0 sm:pb-20 text-center">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->dandori#closeCellModal"></div>
      <div class="relative bg-white rounded-t-xl sm:rounded-lg shadow-xl transform transition-all w-full sm:max-w-2xl max-h-[85vh] sm:max-h-[90vh] overflow-y-auto">
        <div data-dandori-target="cellModalHeader" class="px-4 py-3 border-b bg-orange-50">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <h3 class="text-base sm:text-lg font-medium text-gray-900" data-dandori-target="cellModalTitle">人員配置</h3>
              <span data-dandori-target="cellModalShiftBadge" class="px-2 py-0.5 text-xs font-medium rounded-full bg-orange-100 text-orange-700">日勤</span>
            </div>
            <button type="button" class="text-gray-400 hover:text-gray-500 p-1" data-action="click->dandori#closeCellModal">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-600 mt-1" data-dandori-target="cellModalDate"></p>
        </div>

        <div class="p-4 sm:p-6">
          <!-- 選択数表示 -->
          <div class="mb-4 flex justify-between items-center">
            <span data-dandori-target="cellSelectedCount" class="text-sm font-medium text-gray-700">0名選択中</span>
            <div class="flex gap-2">
              <button type="button" data-action="click->dandori#selectAllInCell" class="text-xs text-blue-600 hover:underline">全選択</button>
              <button type="button" data-action="click->dandori#deselectAllInCell" class="text-xs text-gray-600 hover:underline">全解除</button>
            </div>
          </div>

          <!-- 社員選択（チェックボックス形式） -->
          <div class="space-y-4 max-h-[50vh] overflow-y-auto">
            <!-- 正社員 -->
            <div>
              <p class="text-xs font-medium text-gray-700 mb-2 sticky top-0 bg-white">正社員</p>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                <% @regular_employees.each do |emp| %>
                  <label class="flex items-center gap-2 p-2 border rounded-lg hover:bg-gray-50 cursor-pointer">
                    <input type="checkbox"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           data-dandori-target="cellEmployeeCheckbox"
                           data-employee-id="<%= emp.id %>"
                           data-employee-name="<%= emp.name %>">
                    <span class="text-sm truncate"><%= emp.name %></span>
                    <select data-dandori-target="cellRoleSelect" data-employee-id="<%= emp.id %>"
                            class="ml-auto text-xs border-gray-300 rounded py-0.5 px-1">
                      <option value="worker">作業</option>
                      <option value="foreman">職長</option>
                    </select>
                  </label>
                <% end %>
              </div>
            </div>

            <!-- 仮社員 -->
            <% if @temporary_employees.any? %>
              <div>
                <p class="text-xs font-medium text-gray-700 mb-2 sticky top-0 bg-white">仮社員</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <% @temporary_employees.each do |emp| %>
                    <label class="flex items-center gap-2 p-2 border border-yellow-200 rounded-lg hover:bg-yellow-50 cursor-pointer">
                      <input type="checkbox"
                             class="rounded border-gray-300 text-yellow-600 focus:ring-yellow-500"
                             data-dandori-target="cellEmployeeCheckbox"
                             data-employee-id="<%= emp.id %>"
                             data-employee-name="<%= emp.name %>">
                      <span class="text-sm truncate"><%= emp.name %></span>
                      <select data-dandori-target="cellRoleSelect" data-employee-id="<%= emp.id %>"
                              class="ml-auto text-xs border-gray-300 rounded py-0.5 px-1">
                        <option value="worker">作業</option>
                        <option value="foreman">職長</option>
                      </select>
                    </label>
                  <% end %>
                </div>
              </div>
            <% end %>

            <!-- 外注 -->
            <% if @external_employees.any? %>
              <div>
                <p class="text-xs font-medium text-gray-700 mb-2 sticky top-0 bg-white">外注</p>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  <% @external_employees.each do |emp| %>
                    <label class="flex items-center gap-2 p-2 border border-purple-200 rounded-lg hover:bg-purple-50 cursor-pointer">
                      <input type="checkbox"
                             class="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                             data-dandori-target="cellEmployeeCheckbox"
                             data-employee-id="<%= emp.id %>"
                             data-employee-name="<%= emp.name %>">
                      <span class="text-sm truncate"><%= emp.name %></span>
                      <select data-dandori-target="cellRoleSelect" data-employee-id="<%= emp.id %>"
                              class="ml-auto text-xs border-gray-300 rounded py-0.5 px-1">
                        <option value="worker">作業</option>
                        <option value="foreman">職長</option>
                      </select>
                    </label>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>

          <div class="mt-6 flex justify-end gap-3">
            <button type="button" data-action="click->dandori#closeCellModal"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              キャンセル
            </button>
            <button type="button" data-dandori-target="cellSaveBtn" data-action="click->dandori#saveCellAssignments"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700">
              保存
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 一括配置モーダル -->
  <div data-dandori-target="bulkModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 pt-4 pb-0 sm:pb-20 text-center">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->dandori#closeBulkModal"></div>
      <div class="relative bg-white rounded-t-xl sm:rounded-lg shadow-xl transform transition-all w-full sm:max-w-3xl max-h-[90vh] overflow-y-auto">
        <div class="px-4 py-3 border-b bg-green-50">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">一括配置</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500 p-1" data-action="click->dandori#closeBulkModal">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="p-4 sm:p-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <!-- 案件選択 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">案件</label>
              <select data-dandori-target="projectSelect" data-action="change->dandori#onProjectChange"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                <option value="">選択してください</option>
                <% @projects.each do |p| %>
                  <option value="<%= p.id %>"
                          data-start="<%= p.scheduled_start_date&.strftime('%Y-%m-%d') %>"
                          data-end="<%= p.scheduled_end_date&.strftime('%Y-%m-%d') %>">
                    <%= p.name %>
                  </option>
                <% end %>
              </select>
            </div>

            <!-- 勤務帯 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">勤務帯</label>
              <select data-dandori-target="bulkShift" data-action="change->dandori#updateBulkSummary"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                <option value="day">日勤</option>
                <option value="night">夜勤</option>
              </select>
            </div>

            <!-- 期間 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">開始日</label>
              <input type="date" data-dandori-target="bulkStartDate" data-action="change->dandori#updateBulkSummary"
                     class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">終了日</label>
              <input type="date" data-dandori-target="bulkEndDate" data-action="change->dandori#updateBulkSummary"
                     class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
            </div>

            <!-- 役割 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">役割</label>
              <select data-dandori-target="bulkRole" data-action="change->dandori#updateBulkSummary"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                <option value="worker">作業員</option>
                <option value="foreman">職長</option>
              </select>
            </div>
          </div>

          <!-- 社員選択 -->
          <div class="border-t pt-4">
            <div class="flex justify-between items-center mb-2">
              <p class="text-sm font-medium text-gray-700">社員選択</p>
              <div class="flex gap-2">
                <button type="button" data-action="click->dandori#selectAllEmployees" class="text-xs text-blue-600 hover:underline">全選択</button>
                <button type="button" data-action="click->dandori#deselectAllEmployees" class="text-xs text-gray-600 hover:underline">全解除</button>
                <span data-dandori-target="selectedEmployeesCount" class="text-xs text-gray-500">0名選択中</span>
              </div>
            </div>
            <div class="max-h-48 overflow-y-auto grid grid-cols-3 sm:grid-cols-4 gap-2">
              <% @employees.each do |emp| %>
                <label class="flex items-center gap-1 p-1.5 border rounded hover:bg-gray-50 cursor-pointer text-sm">
                  <input type="checkbox"
                         data-dandori-target="bulkEmployeeCheckbox"
                         data-employee-id="<%= emp.id %>"
                         data-action="change->dandori#updateBulkSummary"
                         class="rounded border-gray-300">
                  <span class="truncate"><%= emp.name %></span>
                </label>
              <% end %>
            </div>
          </div>

          <!-- サマリー -->
          <div data-dandori-target="bulkSummary" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
            案件と作業員を選択してください
          </div>

          <div class="mt-6 flex justify-end gap-3">
            <button type="button" data-action="click->dandori#closeBulkModal"
                    class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
              キャンセル
            </button>
            <button type="button" data-dandori-target="bulkSubmitBtn" data-action="click->dandori#executeBulkAssign"
                    disabled
                    class="px-4 py-2 text-sm font-medium text-white bg-green-600 border border-transparent rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed">
              一括配置を実行
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 備考モーダル -->
  <div data-dandori-target="noteModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-end sm:items-center justify-center min-h-screen px-0 sm:px-4 pt-4 pb-0 sm:pb-20 text-center">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" data-action="click->dandori#closeNoteModal"></div>
      <div class="relative bg-white rounded-t-xl sm:rounded-lg shadow-xl transform transition-all w-full sm:max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="px-4 py-3 border-b bg-amber-50">
          <div class="flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900" data-dandori-target="noteModalTitle">備考</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500 p-1" data-action="click->dandori#closeNoteModal">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <p class="text-sm text-gray-600 mt-1" data-dandori-target="noteModalDate"></p>
        </div>

        <div class="p-4 sm:p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">作業内容</label>
            <textarea data-dandori-target="noteWorkContent" rows="2"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"
                      placeholder="本日の主な作業内容"></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">車両</label>
            <input type="text" data-dandori-target="noteVehicles"
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"
                   placeholder="例: 2tダンプ、軽トラ">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">工具・機材</label>
            <input type="text" data-dandori-target="noteEquipment"
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"
                   placeholder="例: 発電機、溶接機">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">重機搬入</label>
            <input type="text" data-dandori-target="noteHeavyEquipment"
                   class="w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"
                   placeholder="例: バックホー 0.25m³">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">備考・連絡事項</label>
            <textarea data-dandori-target="noteNotes" rows="2"
                      class="w-full rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500"
                      placeholder="その他連絡事項"></textarea>
          </div>

          <div class="flex justify-between items-center pt-2">
            <div class="flex gap-2">
              <button type="button" data-action="click->dandori#copyNote"
                      class="inline-flex items-center px-3 py-1.5 text-xs text-gray-600 hover:bg-gray-50 border rounded-md">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                </svg>
                コピー
              </button>
              <button type="button" data-dandori-target="notePasteBtn" data-action="click->dandori#pasteNote"
                      disabled
                      class="inline-flex items-center px-3 py-1.5 text-xs text-gray-400 border rounded-md disabled:cursor-not-allowed">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                貼り付け
              </button>
            </div>
            <div class="flex gap-3">
              <button type="button" data-action="click->dandori#closeNoteModal"
                      class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                キャンセル
              </button>
              <button type="button" data-dandori-target="noteSaveBtn" data-action="click->dandori#saveNote"
                      class="px-4 py-2 text-sm font-medium text-white bg-amber-600 border border-transparent rounded-md hover:bg-amber-700">
                保存
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
