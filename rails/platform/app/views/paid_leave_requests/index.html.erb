<div class="container mx-auto px-4 py-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">有給休暇申請</h1>
      <p class="text-sm text-gray-600 mt-1">
        <% if can_approve? %>
          社員からの有給申請を確認・承認できます
        <% else %>
          有給休暇の申請と履歴を確認できます
        <% end %>
      </p>
    </div>
    <%= link_to "新規申請", new_paid_leave_request_path,
        class: "px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" %>
  </div>

  <% if can_approve? && @pending_requests&.any? %>
    <%# 承認待ち一覧（管理者のみ） %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6" data-controller="paid-leave-approval">
      <h3 class="text-yellow-800 font-medium mb-4">承認待ち申請（<%= @pending_requests.count %>件）</h3>

      <div class="space-y-4">
        <% @pending_requests.each do |request| %>
          <div class="bg-white rounded-lg shadow p-4 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div>
                <p class="font-medium text-gray-900"><%= request.employee.name %></p>
                <p class="text-sm text-gray-500"><%= request.employee.code %></p>
              </div>
              <div class="text-center px-4 border-l">
                <p class="text-lg font-bold text-gray-900"><%= request.leave_date.strftime("%m/%d") %></p>
                <p class="text-xs text-gray-500"><%= request.leave_date.strftime("%Y年") %></p>
              </div>
              <div class="px-4 border-l">
                <span class="inline-flex items-center px-2 py-1 rounded text-sm bg-gray-100">
                  <%= request.leave_type_label %>
                </span>
                <span class="text-sm text-gray-600 ml-2">(<%= request.consumed_days %>日)</span>
              </div>
              <% if request.reason.present? %>
                <div class="px-4 border-l text-sm text-gray-600 max-w-xs truncate" title="<%= request.reason %>">
                  <%= request.reason %>
                </div>
              <% end %>
            </div>

            <div class="flex items-center gap-2">
              <%= button_to "承認", approve_paid_leave_request_path(request),
                  method: :patch,
                  data: { turbo_confirm: "#{request.employee.name}さんの#{request.leave_date.strftime('%m月%d日')}の有給申請を承認しますか？" },
                  class: "px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700" %>

              <button type="button"
                      data-action="click->paid-leave-approval#showRejectModal"
                      data-request-id="<%= request.id %>"
                      data-employee-name="<%= request.employee.name %>"
                      data-leave-date="<%= request.leave_date.strftime('%m月%d日') %>"
                      class="px-4 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                却下
              </button>
            </div>
          </div>
        <% end %>
      </div>

      <%# 却下理由モーダル %>
      <div data-paid-leave-approval-target="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
          <h3 class="text-lg font-medium text-gray-900 mb-4">申請を却下</h3>
          <p class="text-sm text-gray-600 mb-4">
            <span data-paid-leave-approval-target="modalInfo"></span>
          </p>

          <%= form_with url: "", method: :patch, data: { paid_leave_approval_target: "form" }, class: "space-y-4" do %>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">却下理由（必須）</label>
              <%= text_area_tag :rejection_reason, nil, rows: 3,
                  placeholder: "却下理由を入力してください",
                  class: "w-full border rounded px-3 py-2",
                  required: true,
                  data: { paid_leave_approval_target: "reason" } %>
            </div>
            <div class="flex justify-end gap-2">
              <button type="button"
                      data-action="click->paid-leave-approval#hideModal"
                      class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">
                キャンセル
              </button>
              <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                却下する
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <%# 申請履歴 %>
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-4 py-3 bg-gray-50 border-b">
      <h3 class="font-medium text-gray-900">
        <% if can_approve? %>全社員の申請履歴<% else %>申請履歴<% end %>
      </h3>
    </div>

    <% if @requests.any? %>
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <% if can_approve? %>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">申請者</th>
            <% end %>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">取得日</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">種別</th>
            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">日数</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">理由</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">状態</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">承認者</th>
            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">操作</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <% @requests.each do |request| %>
            <tr class="hover:bg-gray-50">
              <% if can_approve? %>
                <td class="px-4 py-3">
                  <div class="font-medium text-gray-900"><%= request.employee.name %></div>
                  <div class="text-xs text-gray-500"><%= request.employee.code %></div>
                </td>
              <% end %>
              <td class="px-4 py-3 text-sm text-gray-900">
                <%= request.leave_date.strftime("%Y/%m/%d") %>
                <span class="text-gray-500">(<%= %w[日 月 火 水 木 金 土][request.leave_date.wday] %>)</span>
              </td>
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100">
                  <%= request.leave_type_label %>
                </span>
              </td>
              <td class="px-4 py-3 text-sm text-right"><%= request.consumed_days %>日</td>
              <td class="px-4 py-3 text-sm text-gray-600 max-w-xs truncate" title="<%= request.reason %>">
                <%= request.reason.presence || "-" %>
              </td>
              <td class="px-4 py-3 text-center">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs <%= request.status_badge_class %>">
                  <%= request.status_label %>
                </span>
              </td>
              <td class="px-4 py-3 text-sm text-gray-600">
                <% if request.approved_by %>
                  <%= request.approved_by.name %>
                  <div class="text-xs text-gray-400"><%= request.approved_at&.strftime("%m/%d %H:%M") %></div>
                <% else %>
                  -
                <% end %>
              </td>
              <td class="px-4 py-3 text-center">
                <% if request.pending? && request.employee_id == current_employee.id %>
                  <%= button_to "取消", cancel_paid_leave_request_path(request),
                      method: :patch,
                      data: { turbo_confirm: "この申請を取り消しますか？" },
                      class: "text-red-600 hover:underline text-sm" %>
                <% elsif request.rejected? && request.rejection_reason.present? %>
                  <span class="text-red-600 text-xs cursor-help" title="<%= request.rejection_reason %>">
                    理由を見る
                  </span>
                <% else %>
                  -
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="px-4 py-8 text-center text-gray-500">
        申請履歴がありません
      </div>
    <% end %>
  </div>
</div>
