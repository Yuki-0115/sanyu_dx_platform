# 設計判断記録 (DECISIONS.md)

プロジェクトの重要な設計判断と未決定事項を記録します。

---

## 1. 仮置き中の項目（未決定事項）

以下の値は仮置きです。本番稼働前に確定が必要。

| 項目 | 仮置き値 | 備考 |
|------|---------|------|
| 移動距離単価 | 未設定 | km単価？一律？要確認 |
| 経費承認上限 | 未設定 | 職長承認/経理承認の境界金額 |
| 赤字アラート閾値 | 未設定 | 粗利率○%以下で警告？金額ベース？ |

### 確定時のTODO
- [ ] 移動距離単価 → `config/settings.yml` または DB設定
- [ ] 経費承認上限 → `Expense` モデルのバリデーション
- [ ] 赤字アラート閾値 → `Project` モデル or ダッシュボード表示ロジック

---

## 2. 設計判断の理由

### なぜ tenant_id で分離？

**判断**: 全テーブルに `tenant_id` を持たせ、`default_scope` で自動フィルタリング

**理由**:
- 将来的に複数会社（グループ会社等）での利用を想定
- 誤って他社データを参照・更新するリスクを DB 層で排除
- Row Level Security (RLS) 的なアプローチで安全性を担保
- アプリケーション層での WHERE 句漏れを防止

**代替案を採用しなかった理由**:
- スキーマ分離: 運用が複雑、マイグレーションが煩雑
- DB分離: コスト増、横断集計が困難

---

### なぜ日報は職長一括入力？

**判断**: 作業員は日報入力せず、職長が全員分をまとめて入力

**理由**:
- 現場の実態: 作業員がスマホで入力する時間・習慣がない
- 職長が出面を把握しており、一括入力が効率的
- 入力ミス・漏れを職長がチェックできる
- 作業員向けアプリ (Worker Web) は閲覧専用で十分

**トレードオフ**:
- 職長の負担増 → UIの効率化で軽減
- リアルタイム性低下 → 許容範囲（翌日入力でOK）

---

### なぜ出来高と請求は手動紐付け？

**判断**: 出来高（進捗）と請求書は自動連携せず、手動で紐付け

**理由**:
- 建設業の請求タイミングは契約条件により多様
  - 月次請求、出来高請求、完工時一括など
- 出来高100%でも請求しないケースがある（保留金等）
- 自動化すると例外処理が複雑になり、かえって使いにくい
- 経理担当が確認しながら請求書を発行する運用が安全

**将来の拡張**:
- 「出来高から請求書作成」ボタンは検討可能
- あくまで提案であり、最終確定は人間が行う

---

## 3. 触っちゃダメな場所

以下のコードはシステムの根幹です。変更時は十分な検討とテストが必要。

### TenantScoped concern

**場所**: `app/models/concerns/tenant_scoped.rb`

```ruby
# このファイルを変更すると全モデルのテナント分離に影響
module TenantScoped
  extend ActiveSupport::Concern

  included do
    belongs_to :tenant
    default_scope { where(tenant_id: Current.tenant_id) if Current.tenant_id }
    before_validation :set_tenant, on: :create
  end
  # ...
end
```

**変更禁止理由**:
- 全モデルの `default_scope` に影響
- 変更ミスで他テナントのデータが見える重大インシデントに直結
- 変更する場合は全テーブル・全クエリの動作確認が必須

---

### Current.tenant_id の設定箇所

**場所**: `app/controllers/application_controller.rb`

```ruby
def set_current_tenant
  return unless current_employee
  Current.tenant_id = current_employee.tenant_id
  Current.user = current_employee
end
```

**変更禁止理由**:
- ここで設定された `Current.tenant_id` が全モデルのスコープに使用される
- 設定漏れ・誤設定でデータ漏洩の可能性
- API コントローラーなど別の入口を作る場合も同様の設定が必須

---

## 変更履歴

| 日付 | 内容 |
|------|------|
| 2026-01-15 | 初版作成 |
