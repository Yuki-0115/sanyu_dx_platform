# 案件書類ファイリング機能 設計書

## 概要
案件完了後に、その案件に関連する全ての書類が綺麗にファイリングされた状態で閲覧・出力できる機能。

---

## 書類一覧（標準的な建設現場ファイリング）

### 1. 契約関連書類
| 書類名 | 説明 | システム対応状況 |
|--------|------|------------------|
| 見積書 | 顧客への提出見積 | ✅ Estimate モデル |
| 注文書（受領） | 顧客からの注文書 | ⚠️ ファイル添付で対応 |
| 契約書 | 工事請負契約書 | ⚠️ ファイル添付で対応 |
| 発注書（発行） | 協力会社への発注 | ⚠️ 要検討 |

### 2. 現場管理書類
| 書類名 | 説明 | システム対応状況 |
|--------|------|------------------|
| 現場台帳 | 案件の基本情報・工期・担当者等 | ✅ Project モデル |
| 日報 | 日々の作業記録・出面 | ✅ DailyReport モデル |
| 実行予算書 | 予算内訳 | ✅ Budget モデル |
| 原価管理表 | 実績原価の推移 | ✅ 日報から集計 |

### 3. 安全書類（グリーンファイル）
| 書類名 | 説明 | システム対応状況 |
|--------|------|------------------|
| 安全衛生管理計画書 | 現場の安全計画 | ⚠️ SafetyFolder |
| 作業員名簿 | 入場者の一覧 | ⚠️ SafetyFolder |
| 新規入場者教育記録 | 安全教育の記録 | ⚠️ SafetyFolder |
| 持込機械等届出 | 使用機械の届出 | ⚠️ SafetyFolder |
| 工事車両届 | 車両情報 | ⚠️ SafetyFolder |

### 4. 完工・請求関連書類
| 書類名 | 説明 | システム対応状況 |
|--------|------|------------------|
| 完工報告書 | 工事完了の報告 | ❌ 新規追加必要 |
| 検査記録 | 社内検査・顧客検査 | ❌ 新規追加必要 |
| 請求書 | 顧客への請求 | ✅ Invoice モデル |
| 入金記録 | 入金確認 | ✅ Payment モデル |

### 5. その他資料
| 書類名 | 説明 | システム対応状況 |
|--------|------|------------------|
| 現場写真 | 施工前・中・後の写真 | ❌ 新規追加必要 |
| 図面・仕様書 | 設計図面等 | ⚠️ ファイル添付 |
| 打合せ議事録 | 顧客との打合せ記録 | ❌ 新規追加必要 |

---

## ファイリング画面のUI設計

### 画面構成
```
┌─────────────────────────────────────────────────────────────────┐
│ 案件名: ○○ビル改修工事                      [全書類PDF出力]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📁 1. 契約関連                                    [展開/折畳]  │
│  ├── 📄 見積書 (2026/01/05作成)              [PDF] [編集]     │
│  ├── 📎 注文書.pdf (2026/01/10受領)          [DL]  [削除]     │
│  └── 📎 契約書.pdf (2026/01/10締結)          [DL]  [削除]     │
│                                                                 │
│  📁 2. 現場管理                                    [展開/折畳]  │
│  ├── 📄 現場台帳                             [PDF] [編集]     │
│  ├── 📊 日報一覧 (15件)                      [PDF] [詳細]     │
│  ├── 📄 実行予算書                           [PDF] [編集]     │
│  └── 📊 原価管理表                           [PDF] [詳細]     │
│                                                                 │
│  📁 3. 安全書類（グリーンファイル）                [展開/折畳]  │
│  ├── 📎 安全衛生管理計画書.pdf               [DL]  [削除]     │
│  ├── 📎 作業員名簿.xlsx                      [DL]  [削除]     │
│  └── + 安全書類を追加                                          │
│                                                                 │
│  📁 4. 完工・請求                                  [展開/折畳]  │
│  ├── 📄 完工報告書 (2026/03/20)              [PDF] [編集]     │
│  ├── 📄 請求書 #INV-2026-0012                [PDF] [詳細]     │
│  └── ✓ 入金確認済 (2026/04/30)                               │
│                                                                 │
│  📁 5. 写真・資料                                  [展開/折畳]  │
│  ├── 📷 施工前写真 (12枚)                    [ZIP] [詳細]     │
│  ├── 📷 施工中写真 (48枚)                    [ZIP] [詳細]     │
│  ├── 📷 完工写真 (15枚)                      [ZIP] [詳細]     │
│  └── + 写真・資料を追加                                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 実装方針

### Phase 1: 添付ファイル機能（基盤）
1. `ProjectDocument` モデルを作成
   - 書類カテゴリ（契約/現場管理/安全/完工/その他）
   - Active Storage でファイル添付
   - 書類名・説明・アップロード日

### Phase 2: 書類ファイリング画面
1. 案件詳細ページに「書類ファイル」タブを追加
2. カテゴリ別にアコーディオン表示
3. 既存モデル（見積・日報・請求書等）のPDF出力対応

### Phase 3: 一括PDF出力
1. 全書類をまとめたPDFを生成
2. 目次付きで書類を結合
3. ダウンロードまたはDriveへ保存

---

## データモデル

### ProjectDocument（新規）
```ruby
class ProjectDocument < ApplicationRecord
  include TenantScoped

  CATEGORIES = %w[
    contract        # 契約関連
    site_management # 現場管理
    safety          # 安全書類
    completion      # 完工・請求
    photo           # 写真
    other           # その他
  ].freeze

  belongs_to :project
  belongs_to :uploaded_by, class_name: 'Employee'

  has_one_attached :file

  validates :name, presence: true
  validates :category, inclusion: { in: CATEGORIES }
end
```

### マイグレーション
```ruby
create_table :project_documents do |t|
  t.references :tenant, null: false, foreign_key: true
  t.references :project, null: false, foreign_key: true
  t.references :uploaded_by, foreign_key: { to_table: :employees }
  t.string :name, null: false
  t.string :category, null: false
  t.text :description
  t.date :document_date
  t.timestamps
end
```

---

## 次のアクション

### 即時対応
- [ ] ProjectDocument モデル・マイグレーション作成
- [ ] ファイルアップロードUI作成
- [ ] 案件詳細に「書類」タブ追加

### 後続対応（要検討）
- [ ] PDF出力機能（見積書・日報等）
- [ ] 一括PDF生成
- [ ] 写真管理機能の詳細設計
- [ ] Google Drive連携

---

## 補足：よくある追加書類

実務で必要になりやすい書類（ヒアリングで確認）:
- **工程表** - ガントチャートで対応可能
- **施工要領書** - 添付ファイル
- **材料承認願** - 添付ファイル
- **変更指示書** - 追加オーダー管理として検討
- **精算書** - 請求書の一部として対応

---
作成日: 2026-01-19
