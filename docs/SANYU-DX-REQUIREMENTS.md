# 要件定義書：SanyuTech DX Platform

> バージョン：v1.0
> 作成日：2025-01-15
> ステータス：ドラフト（承認待ち）

---

## 1. プロダクト概要

### 基本情報

| 項目 | 内容 |
|------|------|
| プロダクト名 | SanyuTech DX Platform |
| 一言で言うと | 建設会社の数字を一本で繋ぎ、属人化を排除して粗利をリアルタイムで見える化するDXツール |
| 誰の | 株式会社サンユウテック（将来：建設業全般） |
| 何を解決する | 売上・原価の曖昧さ、責任の不明確さ、報告の属人化、ブラックボックス化 |

### ビジョン

> 「数字が見える、壊れない、代わりが効く、成長できる」会社を作る

**4つの柱**
1. **数字が見える**：リアルタイムで経営数字を把握
2. **壊れない**：監査ログで全変更を追跡可能
3. **代わりが効く**：属人化を排除し、仕組みで業務を回す
4. **成長できる**：データに基づく評価・改善サイクル

### 背景・課題

**過去に起きた問題**
- 売上・原価の数字が曖昧なまま進行
- 誰がどの数字に責任を持つか不明確
- 報告・引継ぎがバラバラで情報が閉じていた
- 問題が発覚しても原因追跡が困難
- **各領域が属人化し、社内情報がブラックボックス化**
- **担当者が休む・辞めると業務が止まる**

**なぜDXが必要か**
- 経営判断に必要な数字が信用できない
- トラブル時に責任の所在がわからない
- 同じ問題が繰り返される
- **「あの人しか知らない」状態を解消し、代わりが効く仕組みを作る**

---

## 2. ペルソナ設計

### ペルソナ①：経営層（メインターゲット）

| 項目 | 内容 |
|------|------|
| 名前 | ゆうき（統括） |
| 年齢 | 30代 |
| 役職 | 統括（経営コンサルタント） |
| ITリテラシー | 高 |
| 1日の流れ | 朝：数字確認→昼：各部署調整→夜：戦略検討 |
| 現状の課題 | 各部署の数字がバラバラで全体像が見えない |
| 課題発生タイミング | 月次報告時、問題発覚時 |
| 今の対処法 | 各担当に個別確認（電話・LINE） |
| 理想の状態 | 1画面で全案件の粗利・進捗が見える |

### ペルソナ②：現場管理者

| 項目 | 内容 |
|------|------|
| 名前 | 吉田（工事課長） |
| 年齢 | 50代 |
| 役職 | 工事課長 |
| ITリテラシー | 中 |
| 1日の流れ | 朝：現場配置確認→昼：現場巡回→夜：日報作成 |
| 現状の課題 | 日報入力が面倒、作業員の報告が重複・抜け漏れ |
| 課題発生タイミング | 毎日夕方 |
| 今の対処法 | kintoneで個別入力（時間がかかる） |
| 理想の状態 | 3分で全員分の日報を入力完了 |

### ペルソナ③：経理

| 項目 | 内容 |
|------|------|
| 名前 | 中川（経理） |
| 年齢 | 40代 |
| 役職 | 経理 |
| ITリテラシー | 中 |
| 1日の流れ | 朝：入金確認→昼：請求書処理→夜：帳簿整理 |
| 現状の課題 | 仮社員の相殺計算が複雑、領収書の仕分けが手作業 |
| 課題発生タイミング | 月末締め |
| 今の対処法 | Excel手計算 |
| 理想の状態 | 相殺計算が自動化、freeeに流すデータが整理されている |

### ペルソナ④：外国人作業員

| 項目 | 内容 |
|------|------|
| 名前 | グエン |
| 年齢 | 20代 |
| 役職 | 作業員（仮社員） |
| ITリテラシー | 低〜中 |
| 1日の流れ | 朝：現場移動→昼：作業→夜：帰宅 |
| 現状の課題 | 日本語の入力が難しい、同じ報告を何度もしてしまう |
| 課題発生タイミング | 日報入力時 |
| 今の対処法 | 職長に口頭報告 |
| 理想の状態 | 入力不要（職長が代行）、母語で確認できる |

---

## 3. ユーザーストーリー

### 優先度：高

```
1.
【誰が】統括（ゆうき）として
【何をしたい】全案件の粗利をリアルタイムで一覧表示したい
【なぜ】赤字案件を早期発見し、経営判断を迅速に行いたいから

2.
【誰が】工事課長（吉田）として
【何をしたい】3分で全作業員の日報を一括入力したい
【なぜ】現場作業後に事務作業で時間を取られたくないから

3.
【誰が】営業部長（上原）として
【何をしたい】受注案件を4点チェック完了後に自動で工務に引き継ぎたい
【なぜ】引継ぎ漏れによる着工遅延を防ぎたいから

4.
【誰が】経理（中川）として
【何をしたい】仮社員40名分の給与・社保を出来高から自動相殺したい
【なぜ】月末の手計算で3日かかっている作業を半日に短縮したいから

5.
【誰が】工務（森）として
【何をしたい】着工前に現場条件・安全書類・搬入制限をチェックしたい
【なぜ】準備不足による着工遅延・事故を防ぎたいから
```

### 優先度：中

```
6.
【誰が】職長として
【何をしたい】現場経費の領収書を写真で撮るだけで登録したい
【なぜ】帰社後にまとめて入力する手間を省きたいから

7.
【誰が】事務（岩橋）として
【何をしたい】安全書類を自動生成し、有効期限をアラートで管理したい
【なぜ】期限切れによる現場入場不可を防ぎたいから

8.
【誰が】会長として
【何をしたい】週次で1枚のサマリレポートを自動で受け取りたい
【なぜ】細かい数字を追わずに経営状況を把握したいから
```

---

## 4. 機能一覧（MoSCoW法）

### 【Must】MVP必須（2週間で実装）

#### M-1. 直列型プロセス基盤

| ID | 機能 | 詳細 |
|----|------|------|
| M-1-1 | 案件マスタ | 案件ID中心の全データ紐付け |
| M-1-2 | 4点チェック | 契約書/発注書/入金条件/顧客承認 |
| M-1-3 | 営業→工務引継ぎ | チェックリスト＋自動通知 |
| M-1-4 | 着工前ゲート | 現場条件/夜間/規制/安全書類/搬入 |
| M-1-5 | 変更契約ゲート | 追加工事（売上増）/手直し（記録のみ）分類 |
| M-1-6 | 請求ゲート | 状態管理（未請求/作成中/発行済/入金待ち/入金済/遅延）＋締日ルール |

#### M-2. 原価管理

| ID | 機能 | 詳細 |
|----|------|------|
| M-2-1 | 実行予算作成 | テンプレート＋目標利益率 |
| M-2-2 | 原価入力 | 材料費/外注費/労務費 |
| M-2-3 | 日報（職長一括入力） | 出面＋作業内容＋写真 |
| M-2-4 | 現場経費 | 材料/交通/重機レンタル/リース/消耗品 |
| M-2-5 | 出来高入力 | 金額ベース/月次/工務確定/請求との手動紐付け（MVP） |

#### M-3. 経営ダッシュボード

| ID | 機能 | 詳細 |
|----|------|------|
| M-3-1 | 案件別粗利一覧 | 予定vs実績の乖離表示 |
| M-3-2 | 赤字アラート | 粗利率閾値（要確認）以下で警告 |
| M-3-3 | 未確定売上ボード | 滞留案件の可視化 |
| M-3-4 | 入出金予定 | 支払・入金スケジュール |

#### M-4. 仮社員相殺

| ID | 機能 | 詳細 |
|----|------|------|
| M-4-1 | 仮社員マスタ | 社員ID＋紐づけ協力会社 |
| M-4-2 | 勤怠集計 | 日報→自動集計 |
| M-4-3 | 社保計算 | 協会けんぽ料率テーブル |
| M-4-4 | 相殺処理 | 仮確定＋翌月精算方式 |
| M-4-5 | 例外処理 | 出来高不足→当月別途請求 |

#### M-5. 共通基盤

| ID | 機能 | 詳細 |
|----|------|------|
| M-5-1 | マスタ統一 | 顧客/案件/協力会社/社員/勘定科目/資格 |
| M-5-2 | 権限（RBAC） | 経営/経理/総務/営業/工務工事/作業員 |
| M-5-3 | 承認ワークフロー | 追加工事/外注請求/経費/宿泊交通 |
| M-5-4 | 監査ログ | 誰が・いつ・何を変えたか（優先：売上確定/予算/日報/原価/請求入金） |
| M-5-5 | LINE WORKS通知 | 承認/差戻し/期限/配置 |
| M-5-6 | 案件フォルダ自動生成 | Google Drive連携 |

---

### 【Should】v1.1で追加（MVP後1-2週間）

| ID | 機能 | 詳細 |
|----|------|------|
| S-1 | 配置表（本格版） | ガントチャート表示 |
| S-2 | 営業経費管理 | 交通/接待/通信 |
| S-3 | 販管費経費管理 | 事務用品/備品/光熱費 |
| S-4 | 安全書類生成 | AI生成＋期限管理 |
| S-5 | ヒヤリハット・KY管理 | 報告・是正記録 |
| S-6 | 宿泊・交通手配 | 申請→承認→精算 |
| S-7 | 入社〜教育チェックリスト | 属人化対策 |
| S-8 | 多言語UI | JP/VN/MM |
| S-9 | 協力会社ポータル | 請求書アップ・相殺残高確認 |
| S-10 | 写真台帳 | 出来形/安全/施工前後 |

---

### 【Could】将来検討（Phase 3以降）

| ID | 機能 | 詳細 |
|----|------|------|
| C-1 | 資金繰り予測（AI） | 入出金予測・異常検知 |
| C-2 | 週次/四半期レポート自動生成 | 会長向け1枚サマリ |
| C-3 | KPIツリー | 売上→粗利→稼働→外注比率→材料比率 |
| C-4 | 評価制度基盤 | 入力率/差戻し率/期限遵守/原価精度 |
| C-5 | スキルマップ→教育計画 | 資格・能力の可視化 |
| C-6 | 図面管理・検査記録 | 写真から報告書自動生成 |
| C-7 | OCR（領収書・請求書） | AI提案→人が確定 |
| C-8 | 見積AI提案 | 単価表＋過去実績ベース |
| C-9 | freee API連携 | 自動仕訳・同期 |
| C-10 | マルチテナント化 | 他社展開用 |

---

### 【Won't】今回やらないこと

| ID | 機能 | やらない理由 |
|----|------|-------------|
| W-1 | 会計ソフト自動連携 | 手動確認→freee入力で十分 |
| W-2 | 給与計算機能 | 既存の仕組みを維持 |
| W-3 | 勤怠打刻機能 | 日報で代替 |
| W-4 | 顧客向けポータル | 社内ツール優先 |
| W-5 | モバイルアプリ（ネイティブ） | PWA/レスポンシブWebで代替 |
| W-6 | 複雑な工程表（MS Project級） | シンプルな配置表で代替 |

---

## 5. 機能詳細設計

### 5-1. 直列型プロセス

```
案件登録
    │
    ▼
見積作成
    │
    ▼
【営業】4点チェック ──→ 売上確定
    │    ├─ 契約書あり
    │    ├─ 発注書あり
    │    ├─ 入金条件明記
    │    └─ 顧客承認
    │
    ▼
【営業→工務】引継ぎチェックリスト
    │    ├─ 図面
    │    ├─ 仕様
    │    ├─ 現場条件
    │    └─ 安全上の注意点
    │
    ▼
【工務】着工前ゲート ──→ 着工OK確定
    │    ├─ 現場条件確認
    │    ├─ 夜間・規制確認
    │    ├─ 安全書類完備
    │    └─ 搬入制限確認
    │
    ▼
【工務】実行予算作成 ──→ 予算確定
    │    ├─ 目標利益率設定
    │    └─ 原価内訳（材料/外注/労務）
    │
    ▼
【工事】施工・日報入力
    │
    ├──→【変更発生時】
    │      ├─ 追加工事（売上増）
    │      │    └→ 見積→承認→契約→請求
    │      └─ 手直し（売上なし）
    │           └→ 理由・責任記録のみ
    │
    ▼
【工務】原価確定
    │
    ▼
【経理】請求ゲート ──→ 請求書発行
    │    └─ 締日：月末締め→翌5日発行
    │
    ▼
【経理】入金確認
    │
    ▼
【統括】粗利確定
```

### 5-2. 日報システム

#### コンセプト
**職長が全員分を一括入力 → 勤怠・原価に自動反映**

#### 入力事故防止ルール（MVP必須）

| ルール | 内容 |
|--------|------|
| 二段階確定 | 下書き→確定の2ステップ |
| 確定後修正 | 「訂正申請」扱い（履歴残る） |
| 添付必須条件 | **経費入力がある時のみ**領収書必須（全件必須ではない） |
| 重複防止 | 1人1日1現場1レコード（工程表から自動生成） |
| 確定後ロック | 確定後は編集不可（訂正申請のみ） |

#### 入力フロー

```
【前日まで】
配置表作成（工事課長）
    │
    ▼
翌日の配置確定 → 日報入力枠が自動生成

【当日】
職長 → 配置表から変更分だけ修正して確定
    │
    ▼
日報確定 → 勤怠データ・原価データに自動反映
```

#### 日報入力画面（職長用）

```
┌──────────────────────────────────────────────────┐
│  日報入力：〇〇現場（2025/01/15）                  │
│  天気：晴れ  職長：吉田                           │
├──────────────────────────────────────────────────┤
│  【作業員出面】                                    │
│  ┌──────┬──────┬────────┬────────┬───────────┐  │
│  │ 名前  │ 区分  │ 出勤    │ 時間    │ 移動距離  │  │
│  ├──────┼──────┼────────┼────────┼───────────┤  │
│  │ 田中  │ 正社員│ ○出勤  │ 8:00-17 │ -        │  │
│  │ グエン│ 仮社員│ ○出勤  │ 8:00-17 │ -        │  │
│  │ 山田  │ 正社員│ △半日  │ 8:00-12 │ 60km     │  │
│  │ ＋追加                                        │  │
│  └──────┴──────┴────────┴────────┴───────────┘  │
│  ※移動距離：50km以上のみ入力                      │
│                                                    │
│  【作業内容】                                      │
│  [舗装 ✓] [転圧 ✓] [運搬 ] [その他___]          │
│                                                    │
│  【写真】                                          │
│  [施工前📷] [施工中📷] [施工後📷] [＋追加]       │
│                                                    │
│  【現場経費】                                      │
│  ┌────────┬──────────┬────────┬────────┬─────────┐│
│  │ 区分    │ 内容      │ 金額    │ 支払方法│ 添付    ││
│  ├────────┼──────────┼────────┼────────┼─────────┤│
│  │重機レンタル│ 3tダンプ │ ¥25,000│ 掛け   │ 📄伝票 ││
│  │材料     │ 砕石20t   │ ¥80,000│ 掛け   │ 📄納品書││
│  │交通     │ ガソリン  │ ¥5,000 │ 立替   │ 📷領収書││
│  │＋追加                                         ││
│  └────────┴──────────┴────────┴────────┴─────────┘│
│  ※領収書・伝票の添付は必須                        │
│                                                    │
│  【備考】                                          │
│  [                                              ]  │
│                                                    │
│  [下書き保存] [確定して送信]                       │
└──────────────────────────────────────────────────┘
```

#### 経費入力の選択肢

| 導線 | 対象 | 内容 |
|------|------|------|
| A. 現場で完結 | 小規模 | 職長がその場で全部入力 |
| B. 写真先・経費後 | 大規模 | 現場で写真だけ→帰社後に入力 |

### 5-3. 仮社員相殺システム

#### 概要
外注先の人間を社員化（社保加入）し、給与＋社保会社負担分を出来高から相殺。

#### 規模
約40名

#### MVP設計方針

| 方針 | 内容 |
|------|------|
| 計算まで自動 | 相殺計算結果を自動生成 |
| 確定は手動 | 経理がワンクリックで確定 |
| 例外は繰越 | 入退社/欠勤/遅延→全部翌月繰越に寄せる |

#### 例外処理（MVP）

| 例外 | 処理 |
|------|------|
| 入退社の月跨ぎ | 日割り計算→繰越 |
| 欠勤 | 日報で把握→給与計算は既存フロー |
| 出来高確定遅れ | 見込みで仮確定→翌月精算 |
| 繰越残高 | 協力会社マスタで管理 |

#### 処理フロー

```
【当月】
日報 → 勤怠集計 → 給与計算 → 給与支給
                      │
                      ▼
              社保会社負担算出（協会けんぽ料率）
                      │
                      ▼
出来高（見込み）→ 相殺「仮確定」→ 仮の差額で支払処理
                      │
【翌月】              │
出来高（確定）────────┘
        │
        ▼
    差額精算（繰越）
```

#### 相殺計算

| 項目 | 計算式 |
|------|--------|
| 相殺対象額（A） | 給与総額 + 社保会社負担額 |
| 当月出来高（B） | 日報/出来高から集計 |
| 差額（B-A） | 協力会社への支払額 |

#### 例外処理
- 出来高 < 相殺額 → 当月別途請求（協力会社から徴収）

### 5-4. 出来高管理（MVP定義）

#### 出来高の定義

| 項目 | MVP仕様 |
|------|---------|
| 単位 | **金額**（円） |
| 締め | **月次**（月末締め） |
| 確定者 | **工務**（森） |
| 請求との関係 | **手動紐付け**（出来高≠請求、契約条件次第） |

#### なぜ「手動紐付け」か

- 契約条件が案件ごとに異なる（一括/分割/出来高払い/前払い）
- 自動連動は例外処理が複雑で2週間では間に合わない
- まず「出来高を入力できる」状態を作り、請求連動はPhase2

#### 出来高入力フロー

```
【月次】
工務 → 案件ごとの出来高を入力（金額）
    │
    ▼
工務確定 → 相殺処理の「当月出来高（B）」として使用
    │
    ▼
経理 → 請求金額を別途入力（出来高と照合しながら）
```

#### 将来拡張（Phase2以降）

- 出来高→請求の自動提案
- 契約条件マスタとの連動
- 進捗率（%）管理

### 5-5. 請求状態管理

#### 請求ステータス

| ステータス | 定義 | 次のアクション |
|------------|------|----------------|
| 未請求 | 受注済み・請求書未作成 | 請求書作成 |
| 作成中 | 請求書ドラフト中 | 発行 |
| 発行済 | 顧客に送付済み | 入金待ち |
| 入金待ち | 入金予定日待ち | 入金確認 |
| 入金済 | 入金確認完了 | 完了 |
| 遅延 | 入金予定日を◯日超過 | 督促 |

#### 遅延アラート

| 遅延日数 | アクション |
|----------|------------|
| 7日超過 | 営業に通知 |
| 14日超過 | 統括に通知 |
| 30日超過 | ダッシュボードに赤表示 |

### 5-6. 経費3区分

| 区分 | 入力者 | 計上先 | 経費種別 |
|------|--------|--------|----------|
| 現場経費 | 職長（日報内） | 案件原価 | 材料/交通/重機レンタル/リース/消耗品/食事 |
| 営業経費 | 営業担当 | 販管費（営業） | 交通/接待/通信/その他 |
| 販管費 | 経理・事務 | 販管費（一般） | 事務用品/備品/光熱費/通信/福利厚生 |

#### 共通ルール
- **領収書・伝票添付：経費入力がある時のみ必須**（経費なし日報は添付不要）
- 添付可能：領収書/レンタル伝票/リース伝票/納品書
- 支払方法：現金/会社カード/立替/掛け（後日請求）
- 移動距離：**50km以上のみ報告**

---

## 6. データ設計

### 6-1. マスタ一覧

| マスタ | 主なフィールド |
|--------|----------------|
| 顧客マスタ | 会社名/担当者/連絡先/取引条件 |
| 案件マスタ | 案件名/顧客ID/現場住所/売上/ステータス/フォルダURL |
| 協力会社マスタ | 会社名/仮社員有無/相殺ルール/締日/繰越残高 |
| 社員マスタ | 氏名/雇用区分（正社員/仮社員）/紐づけ協力会社/資格 |
| 勘定科目マスタ | 科目コード/科目名/区分（原価/販管費） |
| 資格マスタ | 資格名/有効期限管理要否 |

### 6-2. トランザクション一覧

| テーブル | 概要 |
|----------|------|
| 見積 | 案件ID/見積金額/版数 |
| 受注 | 案件ID/4点チェック状態/確定日 |
| 実行予算 | 案件ID/目標利益率/原価内訳 |
| 日報 | 案件ID/日付/職長ID/出面サブ/経費サブ/写真/ステータス |
| 出面 | 日報ID/社員ID/出勤区分/時間/移動距離 |
| 経費 | 日報ID or 経費ID/区分/金額/添付/承認状態 |
| 請求 | 案件ID/請求金額/発行日/入金予定日 |
| 入金 | 請求ID/入金日/入金額 |
| 相殺処理 | 年月/協力会社ID/給与総額/社保/出来高/差額/ステータス |

### 6-3. 権限設計（RBAC）

| 権限グループ | 対象者 | 権限範囲 |
|--------------|--------|----------|
| 経営 | 会長/ゆうき | 全閲覧＋全承認 |
| 経理 | 中川 | 会計・請求・支払・相殺 |
| 総務 | 岩橋/小川 | 安全書類・資格・勤怠・宿泊交通 |
| 営業 | 上原 | 案件・見積・契約・顧客 |
| 工務 | 森 | 実行予算・原価・外注・着工前 |
| 工事 | 渡辺/吉田/友納/萩尾 | 日報・工程・配置・追加工事報告 |

### 6-4. 承認ワークフロー

| 対象 | 承認ルート |
|------|------------|
| 4点チェック完了 | 営業→自動で工務に引継ぎ |
| 着工前ゲート | 工務→自動で工事開始可能 |
| 追加工事 | 工事→工務→営業→統括 |
| 手直し | 工事→工務（記録のみ） |
| 外注請求 | 工務→経理 |
| 現場経費 | 職長→工務→（金額により統括） |
| 営業経費 | 営業→統括 |
| 販管費経費 | 事務→経理→（金額により統括） |

### 6-5. 監査ログ優先順位（MVP）

| 優先度 | 対象 | 理由 |
|--------|------|------|
| 1 | 売上確定（4点チェック/受注） | 金額の根拠 |
| 2 | 実行予算 | 利益目標の根拠 |
| 3 | 日報確定 | 原価の根拠 |
| 4 | 原価の修正 | 差異の追跡 |
| 5 | 請求/入金 | キャッシュの根拠 |

**MVP対象外**（Phase2以降）：マスタ変更、権限変更、ログイン履歴

---

## 7. 技術アーキテクチャ

### 7-1. 全体構成

```
┌─────────────────────────────────────────────────────────────┐
│              SanyuTech DX Platform                          │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┼──────────────────┐
        │                  │                  │
   ┌────▼────┐      ┌─────▼──────┐    ┌─────▼──────┐
   │   n8n   │      │ LINE WORKS │    │ PostgreSQL │
   │ (自動化) │      │  (通知)    │    │    (16)    │
   └────┬────┘      └────────────┘    └─────┬──────┘
        │                                    │
   ┌────▼───────────────────────────────────▼────┐
   │          Platform (Rails 8) :3001           │
   │                                              │
   │ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
   │ │ 経営管理 │ │ 総務管理 │ │ 営業管理 │      │
   │ └──────────┘ └──────────┘ └──────────┘      │
   │ ┌──────────┐ ┌──────────┐ ┌──────────┐      │
   │ │ 現場管理 │ │ 日報     │ │ 仮社員   │      │
   │ └──────────┘ └──────────┘ └──────────┘      │
   └─────────────────────────────────────────────┘
        │
   ┌────▼────────────────────────────────────────┐
   │          作業員Web (Rails 8) :3002          │
   │  ・職長日報入力（レスポンシブ）              │
   │  ・工程表閲覧                                │
   │  ・多言語対応 (JP/VN/MM)                     │
   └─────────────────────────────────────────────┘
        │
   ┌────▼────────────────────────────────────────┐
   │          Google Drive                        │
   │  ・案件フォルダ自動生成                      │
   │  ・見積/契約/写真/請求/検査                  │
   └─────────────────────────────────────────────┘
```

### 7-2. 技術スタック

| レイヤー | 技術 | バージョン |
|----------|------|------------|
| インフラ | Docker Compose | 2.0+ |
| DB | PostgreSQL | 16-alpine |
| バックエンド | Ruby on Rails | 8.0 |
| フロントエンド | Hotwire (Turbo + Stimulus) | - |
| CSS | Tailwind CSS | 3.0 |
| 認証 | Devise | 4.9+ |
| 自動化 | n8n | 2.1.1 |
| 通知 | LINE WORKS Webhook | - |
| ストレージ | Google Drive API | - |
| 将来：会計 | freee（手動連携→API） | - |

### 7-3. 外部連携

| 連携先 | 方式 | 用途 |
|--------|------|------|
| LINE WORKS | Webhook | 承認通知/アラート/配置通知 |
| Google Drive | API | 案件フォルダ自動生成/ファイル保存 |
| n8n | Webhook | ワークフロー自動化/定期処理 |
| freee | 手動（将来API） | 経理データ連携 |

---

## 8. 画面一覧

### 8-1. 経営管理（統括/会長）

| 画面 | 機能 |
|------|------|
| ダッシュボード | 案件別粗利/未確定売上/入出金予定 |
| 案件一覧 | 全案件のステータス/担当/金額 |
| 案件詳細 | 4点/予算/原価/日報/請求/入金 |
| 承認一覧 | 未承認の追加工事/経費 |
| アラート一覧 | 赤字/期限/未報告 |

### 8-2. 営業管理（上原）

| 画面 | 機能 |
|------|------|
| 案件登録 | 顧客/物件/金額 |
| 4点チェック | 契約書/発注書/入金条件/顧客承認 |
| 引継ぎチェックリスト | 図面/仕様/現場条件/安全注意 |
| 顧客一覧 | CRM機能 |

### 8-3. 工務管理（森）

| 画面 | 機能 |
|------|------|
| 着工前ゲート | 現場条件/夜間/規制/安全書類/搬入 |
| 実行予算作成 | 目標利益率/原価内訳 |
| 原価管理 | 材料/外注/労務の実績入力 |
| 外注請求管理 | 翌7日必着/概算計上 |

### 8-4. 工事管理（渡辺/課長）

| 画面 | 機能 |
|------|------|
| 配置表 | 誰がどこ/天気表示 |
| 日報入力 | 出面一括/経費/写真 |
| 追加工事報告 | 発生→承認フロー |
| 変更履歴 | 追加工事/手直しの記録 |

### 8-5. 経理管理（中川）

| 画面 | 機能 |
|------|------|
| 入出金管理 | 支払予定/入金予定 |
| 請求管理 | 発行/入金確認 |
| 仮社員相殺 | 月次処理/差額確認 |
| 経費承認 | 領収書確認/科目振り分け |

### 8-6. 作業員Web（職長）

| 画面 | 機能 |
|------|------|
| 今日の現場 | 配置確認/天気 |
| 日報入力 | 出面/経費/写真（スマホ最適化） |
| 工程表閲覧 | 今週の予定 |

---

## 9. 非機能要件

### 9-1. パフォーマンス

| 項目 | 要件 |
|------|------|
| 画面表示 | 3秒以内 |
| 日報入力完了 | 3分以内（15名分） |
| ダッシュボード更新 | リアルタイム（Turbo） |

### 9-2. セキュリティ

| 項目 | 対策 |
|------|------|
| 認証 | Devise + セッション管理 |
| 認可 | RBAC + before_action |
| 監査 | 全変更ログ記録 |
| 通信 | HTTPS必須 |

### 9-3. 可用性

| 項目 | 要件 |
|------|------|
| 稼働時間 | 6:00-22:00（現場時間） |
| バックアップ | 日次（PostgreSQL） |
| 復旧目標 | 4時間以内 |

### 9-4. 拡張性

| 項目 | 設計 |
|------|------|
| マルチテナント | company_code論理分離（将来） |
| 業種テンプレート | 建設業ベース→他業種展開 |
| API | RESTful（将来公開） |

---

## 10. 開発スケジュール

### Week 1：基盤＋コア機能

| Day | 内容 | 成果物 |
|-----|------|--------|
| 1 | プロジェクト初期化・Docker環境 | 動くRails環境 |
| 2 | マスタ設計・DB構築 | 全マスタテーブル |
| 3 | 認証・権限・監査ログ | Devise + RBAC |
| 4 | 案件管理＋4点チェック＋引継ぎ | 営業フロー完成 |
| 5 | 着工前ゲート＋実行予算 | 工務フロー完成 |
| 6 | 日報（職長一括入力） | 出面＋経費＋写真 |
| 7 | 経営ダッシュボード | 粗利/アラート |

### Week 2：連携＋仕上げ

| Day | 内容 | 成果物 |
|-----|------|--------|
| 8 | 配置表＋日報枠自動生成 | 工程管理 |
| 9 | 仮社員相殺処理 | 経理フロー完成 |
| 10 | n8n連携＋LINE WORKS通知 | 通知フロー |
| 11 | 作業員Web（スマホUI） | 職長入力画面 |
| 12 | Google Drive連携 | フォルダ自動生成 |
| 13 | テスト・バグ修正 | 全機能動作確認 |
| 14 | ドキュメント・デプロイ準備 | 運用開始 |

---

## 11. 成功指標（KPI）

### リリース判定基準

- [ ] 案件登録→4点チェック→引継ぎが動作する
- [ ] 実行予算→日報→原価が連動する
- [ ] 経営ダッシュボードで案件別粗利が見える
- [ ] 仮社員相殺計算が正しく動作する
- [ ] LINE WORKS通知が届く

### リリース後1ヶ月の目標

| 指標 | 目標値 |
|------|--------|
| 日報入力率 | 100%（全現場） |
| 日報入力時間 | 5分以内/現場 |
| 月次締め時間 | 50%短縮 |
| 赤字案件検知 | 発生当月内 |

### 運用健康診断KPI（毎日チェック）

| 指標 | 閾値 | アラート |
|------|------|----------|
| 未確定日報件数（当日分） | 0件 | 22時に未確定あれば通知 |
| 未確定日報件数（前日分） | 0件 | 朝9時に残ってれば赤アラート |
| 未承認経費件数 | 5件以上 | 経理に通知 |
| 請求「遅延」件数 | 1件以上 | 統括に通知 |

### 成功と判断する条件

- 「数字が見える」：ダッシュボードで全案件の粗利が把握できる
- 「壊れない」：監査ログで全変更が追跡できる
- 「代わりが効く」：担当者が休んでも業務が止まらない
- 「成長できる」：評価に使えるデータが蓄積される

### 属人化解消チェックリスト

| 領域 | Before（属人化） | After（仕組み化） |
|------|-----------------|-------------------|
| 営業 | 上原しか案件状況を知らない | 4点チェック・引継ぎで可視化 |
| 工務 | 森しか予算の組み方を知らない | テンプレート＋履歴で再現可能 |
| 工事 | 職長の頭の中にしか配置がない | 配置表で全員が見える |
| 経理 | 中川しか相殺計算できない | システムが自動計算 |
| 総務 | 岩橋しか安全書類の期限を知らない | アラートで全員に通知 |

---

## 12. リスク・前提条件

### 前提条件

| 項目 | 内容 |
|------|------|
| 開発体制 | ゆうき＋Claude Code |
| 開発期間 | 2週間（バリバリ稼働） |
| 既存ツール | Google Workspace / LINE WORKS / freee契約済み |
| インフラ | Docker環境構築可能 |

### 依存関係

| 依存 | 内容 |
|------|------|
| LINE WORKS API | Webhook設定が必要 |
| Google Drive API | サービスアカウント設定が必要 |
| 社員データ | 仮社員40名分のマスタデータ |
| 協力会社データ | 相殺ルール・締日の確定 |

### リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 2週間で完成しない | 高 | Must機能に絞る/Should以降は後回し |
| 職長がUI使いこなせない | 中 | シンプル設計/現場テスト早期実施 |
| 仮社員相殺ロジック複雑 | 中 | 仮確定＋翌月精算で単純化 |
| freee連携工数増 | 低 | 手動連携で開始、API化は後 |

---

## 13. 未確定事項（要確認）

| 項目 | 確認内容 | ステータス |
|------|----------|------------|
| 移動距離単価 | ¥?/km（50km以上） | 要確認 |
| 経費承認上限 | ¥?以上で統括承認 | 要確認 |
| 赤字アラート閾値 | 粗利率何%以下で警告？ | 要確認 |
| 請求締日 | 月末締め→翌何日発行？ | 翌5日想定 |
| 1職長あたり担当人数 | 最大15名でOK？ | 確認済み |

---

## 14. 用語集

| 用語 | 定義 |
|------|------|
| 4点チェック | 売上確定の4条件（契約書/発注書/入金条件/顧客承認） |
| 着工前ゲート | 工務が着工可否を判断する関門 |
| 仮社員 | 外注先の人間を社員化（社保加入）した作業員 |
| 相殺 | 仮社員の給与＋社保を協力会社の出来高から差し引く処理 |
| 出面 | 作業員の出勤記録 |
| 粗利 | 売上 - 原価（材料費＋外注費＋労務費＋経費） |

---

## 15. 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-01-15 | 初版作成 |

---

## 16. 承認

| 役割 | 名前 | 承認日 | 署名 |
|------|------|--------|------|
| プロダクトオーナー | ゆうき | | |
| ステークホルダー | 会長 | | |
| ステークホルダー | 森 | | |
| ステークホルダー | 上原 | | |
| ステークホルダー | 渡辺 | | |
| ステークホルダー | 中川 | | |

---

**次のステップ**：承認後 → DESIGN-GUIDE.md で設計フェーズへ
